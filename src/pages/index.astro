---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { courses as coursesTable, reservations } from '../db/schema';
import { gte, eq, and, sql, asc } from 'drizzle-orm';

// Pobierz dzisiejszƒÖ datƒô (poczƒÖtek dnia)
const today = new Date();
today.setHours(0, 0, 0, 0);
const todayISO = today.toISOString().split('T')[0];

// Pobierz kursy z bazy - tylko otwarte i gdzie endDate >= dzisiaj (kurs widoczny w dniu trwania)
const dbCourses = await db.select()
  .from(coursesTable)
  .where(
    and(
      eq(coursesTable.status, 'open'),
      gte(coursesTable.endDate, todayISO)
    )
  )
  .orderBy(asc(coursesTable.startDate));

// Pobierz liczbƒô rezerwacji per kurs (tylko niepotwierdzone/niep≈Çatne)
const reservationCounts = await db.select({
  courseId: reservations.courseId,
  count: sql<number>`count(*)`.as('count')
})
  .from(reservations)
  .where(
    and(
      sql`${reservations.status} NOT IN ('cancelled', 'no_show')`
    )
  )
  .groupBy(reservations.courseId);

const reservationMap = new Map(reservationCounts.map(r => [r.courseId, r.count]));

// Formatuj daty i przygotuj dane dla frontendu
function formatDateRange(startDate: string, endDate: string): string {
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  const startDay = start.getDate().toString().padStart(2, '0');
  const endDay = end.getDate().toString().padStart(2, '0');
  const startMonth = (start.getMonth() + 1).toString().padStart(2, '0');
  const endMonth = (end.getMonth() + 1).toString().padStart(2, '0');
  const year = end.getFullYear();
  
  if (startMonth === endMonth) {
    return `${startDay}-${endDay}.${endMonth}.${year}`;
  } else {
    return `${startDay}.${startMonth}-${endDay}.${endMonth}.${year}`;
  }
}

function isWeekend(startDate: string): boolean {
  const start = new Date(startDate);
  const day = start.getDay();
  return day === 5 || day === 6 || day === 0; // Pt, Sob, Nd
}

function getCourseTypeLabel(type: string): string {
  const labels: Record<string, string> = {
    'podstawowy': 'PODSTAWOWY',
    'cysterny': 'CYSTERNY',
    'klasa1': 'KLASA 1',
    'klasa7': 'KLASA 7',
    'odnowienie': 'ODNOWIENIE',
  };
  return labels[type] || type.toUpperCase();
}

function getCourseNote(type: string, startDate: string): string {
  if (isWeekend(startDate)) return 'weekend';
  if (type === 'cysterny' || type === 'klasa1' || type === 'klasa7') return 'specjalistyczny';
  return '';
}

function getDurationDays(startDate: string, endDate: string): number {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const diffTime = Math.abs(end.getTime() - start.getTime());
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
}

// Znacznik dostƒôpno≈õci (bez pokazywania dok≈Çadnej liczby)
function getAvailabilityBadge(spots: number): { label: string; color: string; bgColor: string } {
  if (spots <= 0) {
    return { label: 'Brak miejsc', color: 'text-red-600', bgColor: 'bg-red-50' };
  } else if (spots <= 5) {
    return { label: 'Ostatnie miejsca!', color: 'text-amber-600', bgColor: 'bg-amber-50' };
  } else {
    return { label: 'Zapisz siƒô', color: 'text-green-600', bgColor: 'bg-green-50' };
  }
}

// Transformuj kursy do formatu frontendu
const courses = dbCourses.map(course => {
  const reservedCount = reservationMap.get(course.id) || 0;
  const availableSpots = (course.maxParticipants || 15) - reservedCount;
  const availability = getAvailabilityBadge(availableSpots);
  
  return {
    id: course.id.toString(),
    date: formatDateRange(course.startDate, course.endDate),
    type: getCourseTypeLabel(course.courseType),
    note: getCourseNote(course.courseType, course.startDate),
    spots: Math.max(0, availableSpots),
    availability,
    days: getDurationDays(course.startDate, course.endDate),
  };
});

const nextCourses = courses.slice(0, 3);
---

<Layout title="ADR Pomorze | Szkolenia ADR i Doradztwo DGSA">
  
  <!-- Hero Section - Mobile First -->
  <section class="relative min-h-[60vh] md:min-h-[80vh] flex items-center overflow-hidden">
    <!-- Hero Background - ADR Tanker -->
    <div class="absolute inset-0 bg-[#0a1628]">
      <img 
        src="/images/hero-tanker.jpg" 
        alt="Cysterna ADR na autostradzie" 
        class="w-full h-full object-cover object-right md:object-center"
        loading="eager"
        fetchpriority="high"
      />
      <!-- Gradient overlay for text readability -->
      <div class="absolute inset-0 bg-gradient-to-r from-[#0a1628]/90 via-[#0a1628]/70 to-transparent"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-[#0a1628]/80 via-transparent to-[#0a1628]/40"></div>
    </div>
    
    <div class="container-custom relative z-10 px-4 md:px-8 py-8 md:py-16">
      <div class="grid lg:grid-cols-2 gap-8 items-center">
        <!-- Left: Content -->
        <div>
          <!-- Mobile: Compact headline -->
          <h1 class="text-3xl md:text-5xl lg:text-6xl font-black text-white leading-tight mb-4 md:mb-6">
            Szkolenia ADR<br>
            <span class="gradient-text">na Pomorzu</span>
          </h1>
          
          <p class="text-lg md:text-xl text-gray-300 mb-6 max-w-xl">
            <strong class="text-white">15 lat do≈õwiadczenia.</strong> Ponad 5000 przeszkolonych kierowc√≥w. Doradztwo DGSA dla firm.
          </p>
          
          <!-- Trust badges - compact on mobile -->
          <div class="flex flex-wrap gap-4 md:gap-6 mb-6">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 bg-white/10 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-[var(--success)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span class="text-white text-sm md:text-base font-medium">15+ lat</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 bg-white/10 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <span class="text-white text-sm md:text-base font-medium">5000+ kierowc√≥w</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 md:w-10 md:h-10 bg-white/10 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-[var(--warning)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <span class="text-white text-sm md:text-base font-medium">100% gwarancji</span>
            </div>
          </div>
          
          <!-- CTAs - hidden on mobile (we have sticky bar) -->
          <div class="hidden md:flex gap-4">
            <a href="#szkolenia" class="btn-primary text-lg px-8 py-4">
              Zapisz siƒô na szkolenie
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
            <a href="/doradztwo" class="inline-flex items-center border-2 border-white text-white hover:bg-white hover:text-[var(--primary)] text-lg px-8 py-4 rounded-lg font-semibold transition-colors">
              Doradztwo DGSA ‚Üí
            </a>
          </div>
        </div>
        
        <!-- Right: Next courses - COMPACT ON MOBILE -->
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-3 md:p-6 border border-white/20">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 bg-[var(--success)] rounded-full animate-pulse"></span>
            <h2 class="text-white font-bold text-base md:text-lg">Najbli≈ºsze terminy</h2>
          </div>
          
          <div class="space-y-2">
            {nextCourses.map((course) => (
              <a href="#szkolenia" class="block bg-white/10 hover:bg-white/20 rounded-lg p-3 transition-all group">
                <div class="flex items-center justify-between gap-2">
                  <div class="min-w-0">
                    <div class="font-mono text-sm md:text-base font-bold text-white">{course.date}</div>
                    <div class="text-gray-300 text-xs md:text-sm truncate">
                      {course.type}
                      {course.note && <span class="text-[var(--accent)] ml-1">‚Ä¢ {course.note}</span>}
                    </div>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span class={`text-xs font-medium ${course.availability.color}`}>{course.availability.label}</span>
                    <svg class="w-4 h-4 text-white/50 group-hover:text-white transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </div>
              </a>
            ))}
          </div>
          
          <a href="#szkolenia" class="block text-center text-white/70 hover:text-white mt-3 text-xs md:text-sm font-medium">
            Wszystkie terminy ‚Üì
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Full Calendar Section with Cart -->
  <section id="szkolenia" class="section-padding bg-gray-50">
    <div class="container-custom">
      <div class="text-center mb-8 md:mb-12">
        <span class="inline-block px-4 py-1 bg-[var(--accent)]/10 text-[var(--accent)] rounded-full text-sm font-semibold mb-4">
          üìÖ KALENDARZ SZKOLE≈É
        </span>
        <h2 class="text-2xl md:text-4xl font-black text-[var(--primary)] mb-2">
          Wybierz terminy i zapisz siƒô
        </h2>
        <p class="text-gray-600">
          <strong class="text-[var(--accent)]">Mo≈ºesz wybraƒá kilka szkole≈Ñ naraz!</strong> Np. ADR + cysterny.
        </p>
      </div>
      
      <!-- Course cards with select buttons -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4 mb-6" id="courses-grid">
        {courses.map((course) => (
          <div 
            class={`course-card bg-white rounded-lg md:rounded-xl p-2.5 md:p-4 border-2 border-gray-200 transition-all hover:shadow-lg group ${course.spots > 0 ? 'cursor-pointer' : 'opacity-75'}`}
            data-id={course.id}
            data-date={course.date}
            data-type={course.type}
            data-note={course.note}
            data-spots={course.spots}
          >
            {/* Header: Typ + Badge */}
            <div class="flex items-center justify-between mb-1 md:mb-2">
              <span class={`font-bold text-xs md:text-base ${course.type === 'CYSTERNY' ? 'text-[var(--accent)]' : 'text-[var(--primary)]'}`}>
                {course.type}
              </span>
              {course.note && (
                <span class={`text-[8px] md:text-[10px] font-bold px-1.5 md:px-2 py-0.5 rounded ${course.note === 'weekend' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}`}>
                  {course.note}
                </span>
              )}
            </div>
            
            {/* Date + Duration */}
            <div class="text-gray-500 text-[11px] md:text-sm mb-2 md:mb-3">
              {course.date} ‚Ä¢ {course.days} {course.days === 1 ? 'dzie≈Ñ' : 'dni'}
            </div>
            
            {/* Separator */}
            <div class="border-t border-gray-100 my-2 md:my-3"></div>
            
            {/* Availability + Button */}
            <div class="flex items-center justify-between">
              <div class={`text-[10px] md:text-xs font-medium ${course.availability.color}`}>
                {course.spots > 0 ? (course.spots <= 5 ? 'üü°' : 'üü¢') : 'üî¥'} {course.availability.label}
              </div>
              {course.spots > 0 ? (
                <button 
                  class="add-course-btn px-2 md:px-4 py-1.5 md:py-2 rounded-md md:rounded-lg font-semibold text-[10px] md:text-sm transition-all
                         bg-gray-100 text-gray-700 hover:bg-[var(--accent)] hover:text-white"
                >
                  <span class="btn-text">+ Dodaj</span>
                </button>
              ) : (
                <span class="px-2 md:px-4 py-1.5 md:py-2 rounded-md md:rounded-lg font-semibold text-[10px] md:text-sm bg-gray-100 text-gray-400">
                  Wyprzedane
                </span>
              )}
            </div>
          </div>
        ))}
      </div>
      
      <p class="text-gray-500 text-sm text-center">
        üí° Szkolenia tak≈ºe u Ciebie w firmie! <a href="#kontakt" class="text-[var(--accent)] underline">Zapytaj o termin</a>
      </p>
    </div>
  </section>
  <!-- Doradztwo Teaser - Link to subpage -->
  <section id="doradztwo" class="py-8 md:py-12 bg-gradient-to-r from-[var(--success)] to-emerald-600">
    <div class="container-custom">
      <a href="/doradztwo" class="block group">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 md:gap-8">
          <div class="flex items-center gap-4 md:gap-6">
            <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
              <svg class="w-7 h-7 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
            <div class="text-center md:text-left">
              <h3 class="text-xl md:text-2xl font-bold text-white mb-1">Doradca DGSA dla Twojej firmy</h3>
              <p class="text-white/80 text-sm md:text-base">Sprawozdania, szkolenia pracownik√≥w, procedury ADR ‚Äî bez zatrudniania etatowca</p>
            </div>
          </div>
          <div class="flex items-center gap-2 bg-white text-[var(--success)] px-5 py-3 rounded-xl font-bold group-hover:bg-gray-100 transition-colors flex-shrink-0">
            Dowiedz siƒô wiƒôcej
            <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </div>
        </div>
      </a>
    </div>
  </section>
  
  <!-- CTA Section -->
  <section id="kontakt" class="section-padding bg-[var(--primary)]">
    <div class="container-custom text-center">
      <h2 class="text-2xl md:text-4xl font-black text-white mb-4 md:mb-6">
        Nie ryzykuj kar.<br>
        <span class="gradient-text">Skontaktuj siƒô dzi≈õ.</span>
      </h2>
      <p class="text-gray-300 mb-6 md:mb-8 max-w-xl mx-auto">
        Bezp≈Çatna konsultacja. Sprawdzimy, czy potrzebujesz doradcy DGSA.
      </p>
      
      <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
        <a href="tel:+48502611639" class="btn-primary text-lg px-8 py-4">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          +48 502 611 639
        </a>
        <a href="mailto:t.bronk@adr-pomorze.pl" class="inline-flex items-center border-2 border-white text-white hover:bg-white hover:text-[var(--primary)] text-lg px-8 py-4 rounded-lg font-semibold transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          t.bronk@adr-pomorze.pl
        </a>
      </div>
      
      <p class="text-gray-400 text-sm">
        üìç Ca≈Çe Pomorze
      </p>
    </div>
  </section>
  
  <!-- Cart Sticky Bar (hidden by default) -->
  <div id="cart-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-[var(--accent)] shadow-2xl z-50 transition-transform duration-300" style="display: none;">
    <div class="container-custom px-4 py-3">
      <div class="flex items-center justify-between gap-4">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg">üõí</span>
            <span class="font-bold text-[var(--primary)]" id="cart-count">0 szkole≈Ñ</span>
          </div>
          <div class="text-xs text-gray-500 truncate" id="cart-summary">Wybierz szkolenia powy≈ºej</div>
        </div>
        <button 
          id="cart-submit-btn"
          class="btn-primary whitespace-nowrap px-6 py-3 flex items-center gap-2"
        >
          Zapisz siƒô
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Registration Modal -->
  <div id="registration-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
          <h3 class="text-lg font-bold text-[var(--primary)]">Zapisz siƒô</h3>
          <button id="modal-close" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <div class="p-4">
          <!-- Selected courses summary -->
          <div class="mb-4">
            <div id="modal-courses" class="space-y-1.5 text-sm">
              <!-- Filled by JS -->
            </div>
          </div>
          
          <!-- Contact form - compact -->
          <form id="registration-form" class="space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Imiƒô i nazwisko *</label>
                <input 
                  type="text" 
                  name="name" 
                  id="input-name"
                  required
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent transition-colors"
                  placeholder="Jan Kowalski"
                />
                <p id="error-name" class="hidden mt-1 text-xs text-red-600 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                  <span></span>
                </p>
              </div>
              
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Telefon *</label>
                <input 
                  type="tel" 
                  name="phone" 
                  id="input-phone"
                  required
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent transition-colors"
                  placeholder="502 611 639"
                />
                <p id="error-phone" class="hidden mt-1 text-xs text-red-600 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                  <span></span>
                </p>
              </div>
            </div>
            
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
              <input 
                type="email" 
                name="email"
                id="input-email"
                required
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent transition-colors"
                placeholder="jan@firma.pl"
              />
              <p id="error-email" class="hidden mt-1 text-xs text-red-600 flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                <span></span>
              </p>
            </div>
            
            <button 
              type="submit"
              class="w-full btn-primary py-3"
            >
              Wy≈õlij zg≈Çoszenie
            </button>
            
            <p class="text-[11px] text-gray-500 text-center">
              Oddzwonimy w ciƒÖgu 24h, aby potwierdziƒá rezerwacjƒô.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] hidden">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl p-8 text-center max-w-md">
        <div class="w-16 h-16 bg-[var(--success)]/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-[var(--success)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-[var(--primary)] mb-2">Dziƒôkujemy!</h3>
        <p class="text-gray-600 mb-6">Twoje zg≈Çoszenie zosta≈Ço przyjƒôte. Oddzwonimy w ciƒÖgu 24 godzin, aby potwierdziƒá rezerwacjƒô.</p>
        <button id="success-close" class="btn-primary">Zamknij</button>
      </div>
    </div>
  </div>
  
  <!-- Spacer for cart bar -->
  <div id="cart-spacer" class="h-0 transition-all duration-300"></div>
  
</Layout>

<style>
  /* Hero map animation - subtle Pomorze glow */
  .hero-map-container {
    position: relative;
  }
  
  .hero-map-image {
    filter: brightness(1.1) saturate(1.2);
  }
  
  /* Animated glow on Pomorze region (top of map) */
  .hero-glow-overlay {
    background: 
      /* Pomorze glow - pulsing */
      radial-gradient(ellipse 30% 20% at 50% 12%, rgba(251, 191, 36, 0.4) 0%, transparent 70%),
      /* Secondary road glow effects */
      radial-gradient(ellipse 15% 8% at 35% 35%, rgba(56, 189, 248, 0.2) 0%, transparent 60%),
      radial-gradient(ellipse 15% 8% at 65% 45%, rgba(56, 189, 248, 0.2) 0%, transparent 60%),
      radial-gradient(ellipse 12% 6% at 50% 55%, rgba(56, 189, 248, 0.15) 0%, transparent 60%);
    animation: pomorzeGlow 3s ease-in-out infinite;
  }
  
  /* Animated light traveling on roads */
  .hero-map-container::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      180deg,
      transparent 0%,
      transparent 8%,
      rgba(251, 191, 36, 0.3) 10%,
      rgba(251, 191, 36, 0.5) 12%,
      rgba(251, 191, 36, 0.3) 14%,
      transparent 16%,
      transparent 100%
    );
    animation: lightTravel 4s ease-in-out infinite;
    pointer-events: none;
    mix-blend-mode: screen;
  }
  
  /* Second light beam on different path */
  .hero-map-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
      ellipse 8% 4% at 50% 15%,
      rgba(255, 255, 255, 0.6) 0%,
      rgba(251, 191, 36, 0.4) 30%,
      transparent 70%
    );
    animation: gdanskPulse 2s ease-in-out infinite;
    pointer-events: none;
  }
  
  @keyframes pomorzeGlow {
    0%, 100% {
      opacity: 0.7;
      filter: blur(0px);
    }
    50% {
      opacity: 1;
      filter: blur(2px);
    }
  }
  
  @keyframes lightTravel {
    0% {
      opacity: 0;
      transform: translateY(-10%);
    }
    20% {
      opacity: 0.8;
    }
    80% {
      opacity: 0.8;
    }
    100% {
      opacity: 0;
      transform: translateY(90%);
    }
  }
  
  @keyframes gdanskPulse {
    0%, 100% {
      opacity: 0.5;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.3);
    }
  }
  
  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .hero-glow-overlay,
    .hero-map-container::before,
    .hero-map-container::after {
      animation: none;
    }
  }
  
  .course-card.selected {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
  }
  
  .course-card.selected .add-course-btn {
    background: var(--success);
    color: white;
  }
  
  #cart-bar.visible {
    transform: translateY(0);
  }
  
  .safe-area-bottom {
    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
  }
</style>

<script>
  // Toast notification
  function showToast(message) {
    const existing = document.getElementById('toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.id = 'toast';
    toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-xl z-[100] text-sm font-medium';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
  }
  
  // Form validation helpers
  function showError(inputId, message) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(inputId.replace('input-', 'error-'));
    if (input && error) {
      input.classList.add('border-red-500', 'bg-red-50');
      input.classList.remove('border-gray-300');
      error.classList.remove('hidden');
      error.querySelector('span').textContent = message;
    }
  }
  
  function clearError(inputId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(inputId.replace('input-', 'error-'));
    if (input && error) {
      input.classList.remove('border-red-500', 'bg-red-50');
      input.classList.add('border-gray-300');
      error.classList.add('hidden');
    }
  }
  
  function validatePhone(phone) {
    // Usu≈Ñ wszystkie znaki opr√≥cz cyfr i +
    const cleaned = phone.replace(/[^\d+]/g, '');
    // Polski numer: 9 cyfr lub +48 + 9 cyfr
    const regex = /^(\+48)?[1-9]\d{8}$/;
    return regex.test(cleaned);
  }
  
  function validateName(name) {
    // Minimum 3 znaki
    return name.trim().length >= 3;
  }
  
  function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email.trim());
  }
  
  // Course Cart Logic
  const cart = new Map();
  
  const cartBar = document.getElementById('cart-bar');
  const cartCount = document.getElementById('cart-count');
  const cartSummary = document.getElementById('cart-summary');
  const cartSpacer = document.getElementById('cart-spacer');
  const cartSubmitBtn = document.getElementById('cart-submit-btn');
  
  const modal = document.getElementById('registration-modal');
  const modalClose = document.getElementById('modal-close');
  const modalCourses = document.getElementById('modal-courses');
  const form = document.getElementById('registration-form');
  
  const successModal = document.getElementById('success-modal');
  const successClose = document.getElementById('success-close');
  
  // Add click handlers to course cards
  document.querySelectorAll('.course-card').forEach(card => {
    const btn = card.querySelector('.add-course-btn');
    if (!btn) return; // Skip cards without button (sold out)
    
    const btnText = btn.querySelector('.btn-text');
    
    const toggle = () => {
      const spots = parseInt(card.dataset.spots || '0');
      if (spots <= 0) {
        showToast('Ten termin jest wyprzedany');
        return;
      }
      
      const id = card.dataset.id;
      const isSelected = cart.has(id);
      
      if (isSelected) {
        cart.delete(id);
        card.classList.remove('selected');
        btnText.textContent = '+ Dodaj';
      } else {
        // Sprawd≈∫ czy ju≈º jest kurs tego samego typu w koszyku
        const courseType = card.dataset.type;
        const existingSameType = Array.from(cart.values()).find(c => c.type === courseType);
        
        if (existingSameType) {
          showToast(`Kurs ${courseType} ju≈º wybrany! Odznacz poprzedni termin, ≈ºeby wybraƒá inny.`);
          return;
        }
        
        cart.set(id, {
          id,
          date: card.dataset.date,
          type: card.dataset.type,
          note: card.dataset.note
        });
        card.classList.add('selected');
        btnText.textContent = '‚úì Wybrano';
      }
      
      updateCartUI();
    };
    
    card.addEventListener('click', toggle);
  });
  
  function updateCartUI() {
    const count = cart.size;
    const items = Array.from(cart.values());
    
    cartCount.textContent = `${count} ${count === 1 ? 'szkolenie' : count < 5 ? 'szkolenia' : 'szkole≈Ñ'}`;
    
    if (items.length > 0) {
      const names = items.map(c => `${c.type} (${c.date})`).join(', ');
      cartSummary.textContent = names;
    } else {
      cartSummary.textContent = 'Wybierz szkolenia powy≈ºej';
    }
    
    // Show/hide cart bar
    if (count > 0) {
      cartBar.style.display = 'block';
      setTimeout(() => cartBar.style.transform = 'translateY(0)', 10);
      cartSpacer.style.height = '80px';
    } else {
      cartBar.style.transform = 'translateY(100%)';
      setTimeout(() => cartBar.style.display = 'none', 300);
      cartSpacer.style.height = '0';
    }
  }
  
  // Open registration modal
  cartSubmitBtn.addEventListener('click', () => {
    if (cart.size === 0) {
      alert('Wybierz co najmniej jedno szkolenie');
      return;
    }
    
    // Populate modal with selected courses
    const items = Array.from(cart.values());
    
    modalCourses.innerHTML = items.map(c => `
      <div class="flex items-center bg-gray-50 rounded-md px-3 py-2">
        <span class="font-medium">${c.type}</span>
        <span class="text-gray-400 mx-1">‚Ä¢</span>
        <span class="text-gray-500">${c.date}</span>
      </div>
    `).join('');
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });
  
  // Close modal
  modalClose.addEventListener('click', () => {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });
  
  // Real-time validation on blur
  const nameInput = document.getElementById('input-name');
  const phoneInput = document.getElementById('input-phone');
  const emailInput = document.getElementById('input-email');
  
  nameInput?.addEventListener('blur', () => {
    if (!validateName(nameInput.value)) {
      showError('input-name', 'Podaj imiƒô i nazwisko');
    } else {
      clearError('input-name');
    }
  });
  
  nameInput?.addEventListener('input', () => clearError('input-name'));
  
  phoneInput?.addEventListener('blur', () => {
    if (phoneInput.value && !validatePhone(phoneInput.value)) {
      showError('input-phone', 'Podaj poprawny numer telefonu (9 cyfr)');
    } else if (!phoneInput.value) {
      showError('input-phone', 'Numer telefonu jest wymagany');
    } else {
      clearError('input-phone');
    }
  });
  
  phoneInput?.addEventListener('input', () => clearError('input-phone'));
  
  emailInput?.addEventListener('blur', () => {
    if (emailInput.value && !validateEmail(emailInput.value)) {
      showError('input-email', 'Podaj poprawny adres email');
    } else if (!emailInput.value) {
      showError('input-email', 'Email jest wymagany');
    } else {
      clearError('input-email');
    }
  });
  
  emailInput?.addEventListener('input', () => clearError('input-email'));
  
  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Clear all errors first
    clearError('input-name');
    clearError('input-phone');
    clearError('input-email');
    
    const formData = new FormData(form);
    const name = formData.get('name')?.toString().trim() || '';
    const phone = formData.get('phone')?.toString().trim() || '';
    const email = formData.get('email')?.toString().trim() || '';
    
    // Validate
    let hasErrors = false;
    
    if (!validateName(name)) {
      showError('input-name', 'Podaj imiƒô i nazwisko');
      hasErrors = true;
    }
    
    if (!phone) {
      showError('input-phone', 'Numer telefonu jest wymagany');
      hasErrors = true;
    } else if (!validatePhone(phone)) {
      showError('input-phone', 'Podaj poprawny numer telefonu (9 cyfr)');
      hasErrors = true;
    }
    
    if (!email) {
      showError('input-email', 'Email jest wymagany');
      hasErrors = true;
    } else if (!validateEmail(email)) {
      showError('input-email', 'Podaj poprawny adres email');
      hasErrors = true;
    }
    
    if (hasErrors) return;
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Wysy≈Çanie...';
    submitBtn.disabled = true;
    
    const data = {
      name,
      phone,
      email: formData.get('email'),
      notes: formData.get('notes'),
      courses: Array.from(cart.values())
    };
    
    try {
      const response = await fetch('/api/reservations/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'B≈ÇƒÖd wysy≈Çania');
      }
      
      // Show success
      modal.classList.add('hidden');
      successModal.classList.remove('hidden');
      
      // Clear cart
      cart.clear();
      document.querySelectorAll('.course-card.selected').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.btn-text').textContent = '+ Dodaj';
      });
      updateCartUI();
      
      form.reset();
      
    } catch (error) {
      showToast('B≈ÇƒÖd wysy≈Çania. Spr√≥buj ponownie lub zadzwo≈Ñ: 502 611 639');
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
  
  // Close success modal
  successClose.addEventListener('click', () => {
    successModal.classList.add('hidden');
    document.body.style.overflow = '';
  });
  
  successModal.addEventListener('click', (e) => {
    if (e.target === successModal) {
      successModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });
  
  // Initialize - hide cart bar on load
  updateCartUI();
</script>
