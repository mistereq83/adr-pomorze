---
import Layout from '../layouts/Layout.astro';
import { db } from '../db';
import { courses, reservations } from '../db/schema';
import { eq } from 'drizzle-orm';
import { findOrCreateParticipant } from '../lib/participants';

let step = 1;
let error = '';
let success = false;
let selectedCourse: any = null;

// Pobierz otwarte kursy
const openCourses = await db.select().from(courses).where(eq(courses.status, 'open')).orderBy(courses.startDate);

// Obsłuż formularz
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'submit') {
      // Znajdź lub utwórz uczestnika (deduplikacja po PESEL/telefon/email)
      const participantResult = await findOrCreateParticipant({
        firstName: formData.get('firstName') as string,
        lastName: formData.get('lastName') as string,
        phone: formData.get('phone') as string,
        email: formData.get('email') as string || '',
        pesel: formData.get('pesel') as string || null,
        hasCurrentAdr: formData.get('hasCurrentAdr') === 'on',
        currentAdrNumber: formData.get('currentAdrNumber') as string || null,
      });
      
      const newParticipant = [participantResult.participant];
      
      // Zapisz rezerwację
      await db.insert(reservations).values({
        courseId: parseInt(formData.get('courseId') as string),
        participantId: newParticipant[0].id,
        status: 'pending',
        paymentMethod: formData.get('paymentMethod') as string || null,
        needsInvoice: formData.get('needsInvoice') === 'on',
        invoiceCompany: formData.get('invoiceCompany') as string || null,
        invoiceNip: formData.get('invoiceNip') as string || null,
        source: 'website',
        consentRules: formData.get('consentRules') === 'on',
        consentRodo: formData.get('consentRodo') === 'on',
        consentNewsletter: formData.get('consentNewsletter') === 'on',
        notes: null,
        createdAt: new Date().toISOString(),
      });
      
      success = true;
    }
  } catch (e) {
    console.error(e);
    error = 'Wystąpił błąd podczas zapisywania zgłoszenia. Spróbuj ponownie lub zadzwoń.';
  }
}

function getCourseTypeLabel(type: string) {
  const labels: Record<string, string> = {
    'podstawowy': 'Kurs podstawowy',
    'cysterny': 'Kurs specjalistyczny - cysterny',
    'klasa1': 'Klasa 1 (materiały wybuchowe)',
    'klasa7': 'Klasa 7 (promieniotwórcze)',
    'odnowienie': 'Szkolenie odnawiające',
  };
  return labels[type] || type;
}
---

<Layout title="Zapisz się na szkolenie | ADR Pomorze">
  <div class="container-custom px-4 py-12">
    <div class="max-w-2xl mx-auto">
      
      {success ? (
        <!-- Success -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h1 class="text-3xl font-bold text-[var(--primary)] mb-4">
            Dziękujemy za zgłoszenie!
          </h1>
          <p class="text-gray-600 mb-6">
            Twoje zgłoszenie zostało przyjęte. Skontaktujemy się z Tobą w ciągu 24 godzin, aby potwierdzić rezerwację.
          </p>
          <div class="bg-gray-50 rounded-xl p-4 mb-6">
            <p class="text-sm text-gray-600">
              Masz pytania? Zadzwoń: <a href="tel:+48502611639" class="font-bold text-[var(--accent)]">502 611 639</a>
            </p>
          </div>
          <a href="/" class="btn-primary">
            Wróć na stronę główną
          </a>
        </div>
      ) : (
        <!-- Form -->
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
          <h1 class="text-2xl md:text-3xl font-bold text-[var(--primary)] mb-2">
            Zapisz się na szkolenie ADR
          </h1>
          <p class="text-gray-600 mb-6">
            Wypełnij formularz, a my skontaktujemy się z Tobą w ciągu 24 godzin.
          </p>
          
          {error && (
            <div class="bg-red-50 text-red-700 p-4 rounded-lg mb-6">
              {error}
            </div>
          )}
          
          <form method="POST" class="space-y-6">
            <input type="hidden" name="action" value="submit" />
            
            <!-- Wybór kursu -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Wybierz termin szkolenia *
              </label>
              <select 
                name="courseId" 
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              >
                <option value="">-- Wybierz termin --</option>
                {openCourses.map(c => (
                  <option value={c.id}>
                    {c.startDate} - {c.endDate} | {getCourseTypeLabel(c.courseType || '')}
                  </option>
                ))}
              </select>
            </div>
            
            <!-- Dane osobowe -->
            <div class="border-t pt-6">
              <h2 class="font-bold text-lg mb-4">Dane osobowe</h2>
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Imię *</label>
                  <input 
                    type="text" 
                    name="firstName" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nazwisko *</label>
                  <input 
                    type="text" 
                    name="lastName" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                  />
                </div>
              </div>
              
              <div class="grid md:grid-cols-2 gap-4 mt-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
                  <input 
                    type="tel" 
                    name="phone" 
                    required
                    placeholder="np. 502 611 639"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input 
                    type="email" 
                    name="email" 
                    placeholder="opcjonalnie"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                  />
                </div>
              </div>
              
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">PESEL (opcjonalnie teraz, wymagany przed szkoleniem)</label>
                <input 
                  type="text" 
                  name="pesel" 
                  maxlength="11"
                  placeholder="Możesz podać później"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                />
              </div>
              
              <div class="mt-4 flex items-start gap-3">
                <input type="checkbox" name="hasCurrentAdr" id="hasCurrentAdr" class="mt-1" />
                <label for="hasCurrentAdr" class="text-sm text-gray-700">
                  Posiadam aktualne zaświadczenie ADR (szkolenie odnawiające)
                </label>
              </div>
              
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nr aktualnego zaświadczenia ADR (jeśli dotyczy)</label>
                <input 
                  type="text" 
                  name="currentAdrNumber" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
                />
              </div>
            </div>
            
            <!-- Faktura -->
            <div class="border-t pt-6">
              <div class="flex items-start gap-3">
                <input type="checkbox" name="needsInvoice" id="needsInvoice" class="mt-1" />
                <label for="needsInvoice" class="text-sm text-gray-700">
                  Potrzebuję fakturę VAT
                </label>
              </div>
              
              <div id="invoiceFields" class="mt-4 hidden space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nazwa firmy</label>
                  <input type="text" name="invoiceCompany" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">NIP</label>
                  <input type="text" name="invoiceNip" class="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
              </div>
            </div>
            
            <!-- Zgody -->
            <div class="border-t pt-6 space-y-3">
              <label class="flex items-start gap-3">
                <input type="checkbox" name="consentRules" required class="mt-1" />
                <span class="text-sm text-gray-700">
                  Akceptuję regulamin szkolenia *
                </span>
              </label>
              
              <label class="flex items-start gap-3">
                <input type="checkbox" name="consentRodo" required class="mt-1" />
                <span class="text-sm text-gray-700">
                  Wyrażam zgodę na przetwarzanie danych osobowych w celu organizacji szkolenia *
                </span>
              </label>
              
              <label class="flex items-start gap-3">
                <input type="checkbox" name="consentNewsletter" class="mt-1" />
                <span class="text-sm text-gray-700">
                  Chcę otrzymywać informacje o nowych terminach szkoleń
                </span>
              </label>
            </div>
            
            <!-- Submit -->
            <div class="pt-4">
              <button type="submit" class="w-full btn-primary py-4 text-lg">
                Wyślij zgłoszenie
              </button>
              <p class="text-center text-sm text-gray-500 mt-4">
                Po wysłaniu zgłoszenia skontaktujemy się z Tobą telefonicznie, aby potwierdzić rezerwację.
              </p>
            </div>
          </form>
        </div>
      )}
      
      <!-- Contact info -->
      {!success && (
        <div class="mt-6 text-center text-gray-600">
          <p>Masz pytania? Zadzwoń: <a href="tel:+48502611639" class="font-bold text-[var(--accent)]">502 611 639</a></p>
        </div>
      )}
    </div>
  </div>
</Layout>

<script is:inline>
document.getElementById('needsInvoice')?.addEventListener('change', function() {
  const fields = document.getElementById('invoiceFields');
  if (this.checked) {
    fields.classList.remove('hidden');
  } else {
    fields.classList.add('hidden');
  }
});
</script>
