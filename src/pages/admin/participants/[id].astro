---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { participants, reservations, courses } from '../../../db/schema';
import { eq, desc } from 'drizzle-orm';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/participants');
}

// ObsÅ‚uga aktualizacji
let message = '';
let messageType = 'success';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'update') {
      await db.update(participants)
        .set({
          firstName: formData.get('firstName') as string,
          lastName: formData.get('lastName') as string,
          phone: formData.get('phone') as string,
          email: formData.get('email') as string || null,
          pesel: formData.get('pesel') as string || null,
          birthDate: formData.get('birthDate') as string || null,
          birthPlace: formData.get('birthPlace') as string || null,
          street: formData.get('street') as string || null,
          city: formData.get('city') as string || null,
          postalCode: formData.get('postalCode') as string || null,
          hasCurrentAdr: formData.get('hasCurrentAdr') === 'on',
          currentAdrNumber: formData.get('currentAdrNumber') as string || null,
          currentAdrExpiry: formData.get('currentAdrExpiry') as string || null,
          driverLicenseCategories: formData.get('driverLicenseCategories') as string || null,
          notes: formData.get('notes') as string || null,
          updatedAt: new Date().toISOString(),
        })
        .where(eq(participants.id, parseInt(id)));
      message = 'Dane uczestnika zaktualizowane';
    } else if (action === 'delete') {
      // SprawdÅº czy ma rezerwacje
      const hasReservations = await db.select()
        .from(reservations)
        .where(eq(reservations.participantId, parseInt(id)))
        .limit(1);
      
      if (hasReservations.length > 0) {
        message = 'Nie moÅ¼na usunÄ…Ä‡ uczestnika z rezerwacjami';
        messageType = 'error';
      } else {
        await db.delete(participants).where(eq(participants.id, parseInt(id)));
        return Astro.redirect('/admin/participants?msg=deleted');
      }
    }
  } catch (e) {
    console.error(e);
    message = 'BÅ‚Ä…d podczas zapisywania';
    messageType = 'error';
  }
}

// Pobierz uczestnika
const participant = await db.select()
  .from(participants)
  .where(eq(participants.id, parseInt(id)))
  .get();

if (!participant) {
  return Astro.redirect('/admin/participants');
}

// Pobierz historiÄ™ rezerwacji z kursami
const participantReservations = await db.select({
  reservation: reservations,
  course: courses,
})
  .from(reservations)
  .leftJoin(courses, eq(reservations.courseId, courses.id))
  .where(eq(reservations.participantId, parseInt(id)))
  .orderBy(desc(reservations.createdAt));

// SprawdÅº czy uprawnienia wygasajÄ… niedÅ‚ugo
const today = new Date();
const adrExpiry = participant.currentAdrExpiry ? new Date(participant.currentAdrExpiry) : null;
const daysToExpiry = adrExpiry ? Math.ceil((adrExpiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)) : null;
const expiryWarning = daysToExpiry !== null && daysToExpiry <= 90 && daysToExpiry > 0;
const expired = daysToExpiry !== null && daysToExpiry <= 0;

function formatDate(dateStr: string | null) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('pl-PL');
}

function getStatusBadge(status: string | null) {
  const badges: Record<string, { class: string; label: string }> = {
    pending: { class: 'bg-yellow-100 text-yellow-800', label: 'Oczekuje' },
    confirmed: { class: 'bg-blue-100 text-blue-800', label: 'Potwierdzona' },
    paid: { class: 'bg-green-100 text-green-800', label: 'OpÅ‚acona' },
    completed: { class: 'bg-gray-100 text-gray-800', label: 'ZakoÅ„czona' },
    cancelled: { class: 'bg-red-100 text-red-800', label: 'Anulowana' },
    no_show: { class: 'bg-red-100 text-red-800', label: 'NieobecnoÅ›Ä‡' },
  };
  return badges[status || 'pending'] || badges.pending;
}

function getCourseTypeLabel(type: string | null) {
  const labels: Record<string, string> = {
    'podstawowy': 'Podstawowy',
    'cysterny': 'Cysterny',
    'klasa1': 'Klasa 1',
    'klasa7': 'Klasa 7',
    'odnowienie': 'Odnowienie',
  };
  return labels[type || ''] || type || '-';
}
---

<AdminLayout title={`${participant.lastName} ${participant.firstName}`}>
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <a href="/admin/participants" class="text-gray-500 hover:text-gray-700 text-sm mb-2 inline-flex items-center gap-1">
          â† PowrÃ³t do listy
        </a>
        <h1 class="text-2xl font-bold text-gray-900">
          {participant.lastName} {participant.firstName}
        </h1>
      </div>
      <a href={`/admin/reservations/new?participantId=${participant.id}`} class="btn-primary">
        + Nowa rezerwacja
      </a>
    </div>

    {message && (
      <div class={`mb-4 p-4 rounded-lg ${messageType === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : 'bg-green-50 border border-green-200 text-green-800'}`}>
        {message}
      </div>
    )}

    <!-- OstrzeÅ¼enie o wygasajÄ…cych uprawnieniach -->
    {(expiryWarning || expired) && (
      <div class={`mb-6 p-4 rounded-xl flex items-center gap-3 ${expired ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'}`}>
        <span class="text-2xl">{expired ? 'ğŸš¨' : 'âš ï¸'}</span>
        <div>
          <div class={`font-bold ${expired ? 'text-red-800' : 'text-yellow-800'}`}>
            {expired ? 'Uprawnienia ADR wygasÅ‚y!' : `Uprawnienia ADR wygasajÄ… za ${daysToExpiry} dni`}
          </div>
          <div class={`text-sm ${expired ? 'text-red-600' : 'text-yellow-700'}`}>
            Data waÅ¼noÅ›ci: {formatDate(participant.currentAdrExpiry)}
            {!expired && ' â€” czas na kurs odnowieniowy!'}
          </div>
        </div>
        <a href={`/admin/reservations/new?participantId=${participant.id}`} class="ml-auto btn-primary text-sm">
          Zapisz na kurs
        </a>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Formularz edycji - 2 kolumny -->
      <div class="lg:col-span-2">
        <form method="POST" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <input type="hidden" name="action" value="update" />
          
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸ‘¤</span> Dane osobowe
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ImiÄ™ *</label>
              <input 
                type="text" 
                name="firstName" 
                value={participant.firstName}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nazwisko *</label>
              <input 
                type="text" 
                name="lastName" 
                value={participant.lastName}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">PESEL</label>
              <input 
                type="text" 
                name="pesel" 
                value={participant.pesel || ''}
                maxlength="11"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Data urodzenia</label>
              <input 
                type="date" 
                name="birthDate" 
                value={participant.birthDate || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Miejsce urodzenia</label>
              <input 
                type="text" 
                name="birthPlace" 
                value={participant.birthPlace || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸ“</span> Kontakt
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
              <input 
                type="tel" 
                name="phone" 
                value={participant.phone}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input 
                type="email" 
                name="email" 
                value={participant.email || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸ“</span> Adres
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ulica i numer</label>
              <input 
                type="text" 
                name="street" 
                value={participant.street || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kod pocztowy</label>
              <input 
                type="text" 
                name="postalCode" 
                value={participant.postalCode || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Miasto</label>
              <input 
                type="text" 
                name="city" 
                value={participant.city || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸš›</span> Uprawnienia ADR
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="col-span-2">
              <label class="flex items-center gap-2">
                <input 
                  type="checkbox" 
                  name="hasCurrentAdr"
                  checked={participant.hasCurrentAdr}
                  class="w-5 h-5 rounded border-gray-300 text-[var(--accent)] focus:ring-[var(--accent)]"
                />
                <span class="font-medium">Posiada aktualne zaÅ›wiadczenie ADR</span>
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Numer zaÅ›wiadczenia</label>
              <input 
                type="text" 
                name="currentAdrNumber" 
                value={participant.currentAdrNumber || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Data waÅ¼noÅ›ci ADR</label>
              <input 
                type="date" 
                name="currentAdrExpiry" 
                value={participant.currentAdrExpiry || ''}
                class={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent ${expired ? 'border-red-500 bg-red-50' : expiryWarning ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'}`}
              />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie prawa jazdy</label>
              <input 
                type="text" 
                name="driverLicenseCategories" 
                value={participant.driverLicenseCategories || ''}
                placeholder="np. B, C, C+E"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸ“</span> Notatki
          </h2>
          
          <div class="mb-6">
            <textarea 
              name="notes"
              rows="4"
              placeholder="Dodatkowe informacje o uczestniku, preferencje, uwagi..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
            >{participant.notes || ''}</textarea>
          </div>

          <div class="flex justify-between items-center pt-4 border-t">
            <button 
              type="button"
              onclick="document.getElementById('deleteModal').showModal()"
              class="text-red-600 hover:text-red-800 text-sm"
            >
              ğŸ—‘ï¸ UsuÅ„ uczestnika
            </button>
            <button type="submit" class="btn-primary">
              Zapisz zmiany
            </button>
          </div>
        </form>
      </div>

      <!-- Sidebar - historia i podsumowanie -->
      <div class="space-y-6">
        <!-- Podsumowanie -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">ğŸ“Š Podsumowanie</h2>
          <dl class="space-y-3">
            <div class="flex justify-between">
              <dt class="text-gray-500">SzkoleÅ„ Å‚Ä…cznie</dt>
              <dd class="font-bold text-[var(--accent)]">{participantReservations.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">W bazie od</dt>
              <dd class="font-medium">{formatDate(participant.createdAt)}</dd>
            </div>
            {participant.updatedAt && (
              <div class="flex justify-between">
                <dt class="text-gray-500">Ostatnia aktualizacja</dt>
                <dd class="text-sm">{formatDate(participant.updatedAt)}</dd>
              </div>
            )}
            {participant.hasCurrentAdr && participant.currentAdrExpiry && (
              <div class="flex justify-between">
                <dt class="text-gray-500">ADR waÅ¼ne do</dt>
                <dd class={`font-medium ${expired ? 'text-red-600' : expiryWarning ? 'text-yellow-600' : 'text-green-600'}`}>
                  {formatDate(participant.currentAdrExpiry)}
                </dd>
              </div>
            )}
          </dl>
        </div>

        <!-- Historia szkoleÅ„ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">ğŸ“š Historia szkoleÅ„</h2>
          
          {participantReservations.length === 0 ? (
            <p class="text-gray-500 text-sm">Brak historii szkoleÅ„</p>
          ) : (
            <div class="space-y-3">
              {participantReservations.map((r) => (
                <a 
                  href={`/admin/reservations/${r.reservation.id}`}
                  class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm">
                      {getCourseTypeLabel(r.course?.courseType)}
                    </span>
                    <span class={`px-2 py-0.5 rounded text-xs ${getStatusBadge(r.reservation.status).class}`}>
                      {getStatusBadge(r.reservation.status).label}
                    </span>
                  </div>
                  <div class="text-xs text-gray-500">
                    {r.course ? `${formatDate(r.course.startDate)} - ${formatDate(r.course.endDate)}` : 'Brak kursu'}
                  </div>
                </a>
              ))}
            </div>
          )}
        </div>

        <!-- Szybkie akcje -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">âš¡ Szybkie akcje</h2>
          <div class="space-y-2">
            {participant.phone && (
              <a 
                href={`tel:${participant.phone}`}
                class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
              >
                <span>ğŸ“</span> ZadzwoÅ„
              </a>
            )}
            {participant.email && (
              <a 
                href={`mailto:${participant.email}`}
                class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
              >
                <span>âœ‰ï¸</span> WyÅ›lij email
              </a>
            )}
            <a 
              href={`/admin/reservations/new?participantId=${participant.id}`}
              class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
            >
              <span>â•</span> Dodaj rezerwacjÄ™
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal usuwania -->
  <dialog id="deleteModal" class="rounded-xl p-0 backdrop:bg-black/50">
    <div class="p-6 max-w-md">
      <h3 class="text-lg font-bold text-gray-900 mb-2">UsuÅ„ uczestnika?</h3>
      <p class="text-gray-600 mb-4">
        Czy na pewno chcesz usunÄ…Ä‡ <strong>{participant.lastName} {participant.firstName}</strong>? 
        Ta operacja jest nieodwracalna.
      </p>
      <div class="flex justify-end gap-2">
        <button 
          onclick="document.getElementById('deleteModal').close()"
          class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
        >
          Anuluj
        </button>
        <form method="POST">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            UsuÅ„
          </button>
        </form>
      </div>
    </div>
  </dialog>
</AdminLayout>
