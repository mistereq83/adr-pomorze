---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { participants, reservations, courses, adrCertificates } from '../../../db/schema';
import { eq, desc } from 'drizzle-orm';
import { validateAndNormalizePhone } from '../../../lib/phone';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/participants');
}

// Obs≈Çuga aktualizacji
let message = '';
let messageType = 'success';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'update') {
      // Walidacja numeru telefonu
      const rawPhone = formData.get('phone') as string;
      const normalizedPhone = validateAndNormalizePhone(rawPhone);
      
      if (!normalizedPhone) {
        message = 'Nieprawid≈Çowy numer telefonu. Podaj 9-cyfrowy polski numer kom√≥rkowy.';
        messageType = 'error';
        throw new Error(message);
      }
      
      await db.update(participants)
        .set({
          firstName: formData.get('firstName') as string,
          lastName: formData.get('lastName') as string,
          phone: normalizedPhone,
          email: formData.get('email') as string || null,
          pesel: formData.get('pesel') as string || null,
          birthDate: formData.get('birthDate') as string || null,
          birthPlace: formData.get('birthPlace') as string || null,
          street: formData.get('street') as string || null,
          city: formData.get('city') as string || null,
          postalCode: formData.get('postalCode') as string || null,
          hasCurrentAdr: formData.get('hasCurrentAdr') === 'on',
          currentAdrNumber: formData.get('currentAdrNumber') as string || null,
          currentAdrExpiry: formData.get('currentAdrExpiry') as string || null,
          driverLicenseCategories: formData.getAll('licenseCategories').join(',') || null,
          notes: formData.get('notes') as string || null,
          updatedAt: new Date().toISOString(),
        })
        .where(eq(participants.id, parseInt(id)));
      message = 'Dane uczestnika zaktualizowane';
    } else if (action === 'delete') {
      // Sprawd≈∫ czy ma rezerwacje
      const hasReservations = await db.select()
        .from(reservations)
        .where(eq(reservations.participantId, parseInt(id)))
        .limit(1);
      
      if (hasReservations.length > 0) {
        message = 'Nie mo≈ºna usunƒÖƒá uczestnika z rezerwacjami';
        messageType = 'error';
      } else {
        await db.delete(participants).where(eq(participants.id, parseInt(id)));
        return Astro.redirect('/admin/participants?msg=deleted');
      }
    }
  } catch (e) {
    console.error(e);
    message = 'B≈ÇƒÖd podczas zapisywania';
    messageType = 'error';
  }
}

// Pobierz uczestnika
const participant = await db.select()
  .from(participants)
  .where(eq(participants.id, parseInt(id)))
  .get();

if (!participant) {
  return Astro.redirect('/admin/participants');
}

// Pobierz historiƒô rezerwacji z kursami
const participantReservations = await db.select({
  reservation: reservations,
  course: courses,
})
  .from(reservations)
  .leftJoin(courses, eq(reservations.courseId, courses.id))
  .where(eq(reservations.participantId, parseInt(id)))
  .orderBy(desc(reservations.createdAt));

// Pobierz historiƒô certyfikat√≥w ADR
const participantCertificates = await db.select({
  certificate: adrCertificates,
  course: courses,
})
  .from(adrCertificates)
  .leftJoin(courses, eq(adrCertificates.courseId, courses.id))
  .where(eq(adrCertificates.participantId, parseInt(id)))
  .orderBy(desc(adrCertificates.expiryDate));

// Sprawd≈∫ czy uprawnienia wygasajƒÖ nied≈Çugo
const today = new Date();
const adrExpiry = participant.currentAdrExpiry ? new Date(participant.currentAdrExpiry) : null;
const daysToExpiry = adrExpiry ? Math.ceil((adrExpiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)) : null;
const expiryWarning = daysToExpiry !== null && daysToExpiry <= 90 && daysToExpiry > 0;
const expired = daysToExpiry !== null && daysToExpiry <= 0;

function formatDate(dateStr: string | null) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('pl-PL');
}

function getStatusBadge(status: string | null) {
  const badges: Record<string, { class: string; label: string }> = {
    pending: { class: 'bg-yellow-100 text-yellow-800', label: 'Oczekuje' },
    confirmed: { class: 'bg-blue-100 text-blue-800', label: 'Potwierdzona' },
    paid: { class: 'bg-green-100 text-green-800', label: 'Op≈Çacona' },
    completed: { class: 'bg-gray-100 text-gray-800', label: 'Zako≈Ñczona' },
    cancelled: { class: 'bg-red-100 text-red-800', label: 'Anulowana' },
    no_show: { class: 'bg-red-100 text-red-800', label: 'Nieobecno≈õƒá' },
  };
  return badges[status || 'pending'] || badges.pending;
}

function getCourseTypeLabel(type: string | null) {
  const labels: Record<string, string> = {
    'podstawowy': 'Podstawowy',
    'cysterny': 'Cysterny',
    'klasa1': 'Klasa 1',
    'klasa7': 'Klasa 7',
    'odnowienie': 'Odnowienie',
  };
  return labels[type || ''] || type || '-';
}
---

<AdminLayout title={`${participant.lastName} ${participant.firstName}`}>
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <a href="/admin/participants" class="text-gray-500 hover:text-gray-700 text-sm inline-flex items-center gap-1">
        ‚Üê Powr√≥t do listy
      </a>
      <a href={`/admin/reservations/new?participantId=${participant.id}`} class="btn-primary">
        + Nowa rezerwacja
      </a>
    </div>

    {message && (
      <div class={`mb-4 p-4 rounded-lg ${messageType === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : 'bg-green-50 border border-green-200 text-green-800'}`}>
        {message}
      </div>
    )}

    <!-- Ostrze≈ºenie o wygasajƒÖcych uprawnieniach -->
    {(expiryWarning || expired) && (
      <div class={`mb-6 p-4 rounded-xl flex items-center gap-3 ${expired ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'}`}>
        <span class="text-2xl">{expired ? 'üö®' : '‚ö†Ô∏è'}</span>
        <div>
          <div class={`font-bold ${expired ? 'text-red-800' : 'text-yellow-800'}`}>
            {expired ? 'Uprawnienia ADR wygas≈Çy!' : `Uprawnienia ADR wygasajƒÖ za ${daysToExpiry} dni`}
          </div>
          <div class={`text-sm ${expired ? 'text-red-600' : 'text-yellow-700'}`}>
            Data wa≈ºno≈õci: {formatDate(participant.currentAdrExpiry)}
            {!expired && ' ‚Äî czas na kurs odnowieniowy!'}
          </div>
        </div>
        <a href={`/admin/reservations/new?participantId=${participant.id}`} class="ml-auto btn-primary text-sm">
          Zapisz na kurs
        </a>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Formularz edycji - 2 kolumny -->
      <div class="lg:col-span-2">
        <form method="POST" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <input type="hidden" name="action" value="update" />
          
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">üë§</span> Dane osobowe
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Imiƒô *</label>
              <input 
                type="text" 
                name="firstName" 
                value={participant.firstName}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nazwisko *</label>
              <input 
                type="text" 
                name="lastName" 
                value={participant.lastName}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">PESEL</label>
              <input 
                type="text" 
                name="pesel" 
                value={participant.pesel || ''}
                maxlength="11"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Data urodzenia</label>
              <input 
                type="date" 
                name="birthDate" 
                value={participant.birthDate || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Miejsce urodzenia</label>
              <input 
                type="text" 
                name="birthPlace" 
                value={participant.birthPlace || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">üìû</span> Kontakt
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Telefon *</label>
              <input 
                type="tel" 
                name="phone" 
                value={participant.phone}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input 
                type="email" 
                name="email" 
                value={participant.email || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">üìç</span> Adres
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ulica i numer</label>
              <input 
                type="text" 
                name="street" 
                value={participant.street || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Kod pocztowy</label>
              <input 
                type="text" 
                name="postalCode" 
                value={participant.postalCode || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Miasto</label>
              <input 
                type="text" 
                name="city" 
                value={participant.city || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
              />
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">üöõ</span> Uprawnienia ADR
          </h2>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="col-span-2">
              <label class="flex items-center gap-2">
                <input 
                  type="checkbox" 
                  name="hasCurrentAdr"
                  checked={participant.hasCurrentAdr}
                  class="w-5 h-5 rounded border-gray-300 text-[var(--accent)] focus:ring-[var(--accent)]"
                />
                <span class="font-medium">Posiada aktualne za≈õwiadczenie ADR</span>
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Numer za≈õwiadczenia</label>
              <input 
                type="text" 
                name="currentAdrNumber" 
                value={participant.currentAdrNumber || ''}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Data wa≈ºno≈õci ADR</label>
              <input 
                type="date" 
                name="currentAdrExpiry" 
                value={participant.currentAdrExpiry || ''}
                class={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent ${expired ? 'border-red-500 bg-red-50' : expiryWarning ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'}`}
              />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie prawa jazdy</label>
              <div class="flex flex-wrap gap-2">
                {['AM', 'A1', 'A2', 'A', 'B1', 'B', 'B+E', 'C1', 'C1+E', 'C', 'C+E', 'D1', 'D1+E', 'D', 'D+E', 'T'].map(cat => (
                  <label class="flex items-center gap-1 px-2 py-1 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer text-sm">
                    <input 
                      type="checkbox" 
                      name="licenseCategories"
                      value={cat}
                      checked={participant.driverLicenseCategories?.includes(cat)}
                      class="w-3.5 h-3.5 rounded border-gray-300 text-[var(--accent)]"
                    />
                    <span>{cat}</span>
                  </label>
                ))}
              </div>
            </div>
          </div>

          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span class="text-xl">üìù</span> Notatki
          </h2>
          
          <div class="mb-6">
            <textarea 
              name="notes"
              rows="4"
              placeholder="Dodatkowe informacje o uczestniku, preferencje, uwagi..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
            >{participant.notes || ''}</textarea>
          </div>

          <div class="flex justify-between items-center pt-4 border-t">
            <button 
              type="button"
              onclick="document.getElementById('deleteModal').showModal()"
              class="text-red-600 hover:text-red-800 text-sm"
            >
              üóëÔ∏è Usu≈Ñ uczestnika
            </button>
            <button type="submit" class="btn-primary">
              Zapisz zmiany
            </button>
          </div>
        </form>
      </div>

      <!-- Sidebar - historia i podsumowanie -->
      <div class="space-y-6">
        <!-- Podsumowanie -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">üìä Podsumowanie</h2>
          <dl class="space-y-3">
            <div class="flex justify-between">
              <dt class="text-gray-500">Szkole≈Ñ ≈ÇƒÖcznie</dt>
              <dd class="font-bold text-[var(--accent)]">{participantReservations.length}</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-gray-500">W bazie od</dt>
              <dd class="font-medium">{formatDate(participant.createdAt)}</dd>
            </div>
            {participant.updatedAt && (
              <div class="flex justify-between">
                <dt class="text-gray-500">Ostatnia aktualizacja</dt>
                <dd class="text-sm">{formatDate(participant.updatedAt)}</dd>
              </div>
            )}
            {participant.hasCurrentAdr && participant.currentAdrExpiry && (
              <div class="flex justify-between">
                <dt class="text-gray-500">ADR wa≈ºne do</dt>
                <dd class={`font-medium ${expired ? 'text-red-600' : expiryWarning ? 'text-yellow-600' : 'text-green-600'}`}>
                  {formatDate(participant.currentAdrExpiry)}
                </dd>
              </div>
            )}
          </dl>
        </div>

        <!-- Historia szkole≈Ñ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">üìö Historia szkole≈Ñ</h2>
          
          {participantReservations.length === 0 ? (
            <p class="text-gray-500 text-sm">Brak historii szkole≈Ñ</p>
          ) : (
            <div class="space-y-3">
              {participantReservations.map((r) => (
                <a 
                  href={`/admin/reservations/${r.reservation.id}`}
                  class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm">
                      {getCourseTypeLabel(r.course?.courseType)}
                    </span>
                    <span class={`px-2 py-0.5 rounded text-xs ${getStatusBadge(r.reservation.status).class}`}>
                      {getStatusBadge(r.reservation.status).label}
                    </span>
                  </div>
                  <div class="text-xs text-gray-500">
                    {r.course ? `${formatDate(r.course.startDate)} - ${formatDate(r.course.endDate)}` : 'Brak kursu'}
                  </div>
                </a>
              ))}
            </div>
          )}
        </div>

        <!-- Historia certyfikat√≥w ADR -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">üèÜ Historia ADR</h2>
            <button 
              onclick="document.getElementById('addCertModal').showModal()"
              class="text-xs bg-[var(--accent)] text-white px-2 py-1 rounded hover:bg-opacity-90"
            >
              + Dodaj
            </button>
          </div>
          
          {participantCertificates.length === 0 ? (
            <p class="text-gray-500 text-sm">Brak wpis√≥w. {participant.hasCurrentAdr ? 'Dodaj aktualne uprawnienia.' : 'To bƒôdƒÖ pierwsze uprawnienia.'}</p>
          ) : (
            <div class="space-y-3">
              {participantCertificates.map((c) => (
                <div 
                  class={`p-3 rounded-lg border ${c.certificate.status === 'active' ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}
                >
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm">{c.certificate.classes}</span>
                    <span class={`px-2 py-0.5 rounded text-xs ${
                      c.certificate.status === 'active' ? 'bg-green-100 text-green-800' : 
                      c.certificate.status === 'renewed' ? 'bg-blue-100 text-blue-800' : 
                      'bg-red-100 text-red-800'
                    }`}>
                      {c.certificate.status === 'active' ? 'Aktywny' : c.certificate.status === 'renewed' ? 'Odnowiony' : 'Wygas≈Çy'}
                    </span>
                  </div>
                  <div class="text-xs text-gray-600">
                    {c.certificate.isFirst && <span class="text-purple-600 font-medium">Pierwsze uprawnienia ‚Ä¢ </span>}
                    Wa≈ºne do: <span class="font-mono">{formatDate(c.certificate.expiryDate)}</span>
                  </div>
                  {c.certificate.certificateNumber && (
                    <div class="text-xs text-gray-500 mt-1">
                      Nr: {c.certificate.certificateNumber}
                    </div>
                  )}
                  {c.course && (
                    <div class="text-xs text-gray-500 mt-1">
                      Kurs u nas: {formatDate(c.course.startDate)}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        <!-- Szybkie akcje -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold mb-4">‚ö° Szybkie akcje</h2>
          <div class="space-y-2">
            {participant.phone && (
              <a 
                href={`tel:${participant.phone}`}
                class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
              >
                <span>üìû</span> Zadzwo≈Ñ
              </a>
            )}
            {participant.email && (
              <a 
                href={`mailto:${participant.email}`}
                class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
              >
                <span>‚úâÔ∏è</span> Wy≈õlij email
              </a>
            )}
            <a 
              href={`/admin/reservations/new?participantId=${participant.id}`}
              class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-sm"
            >
              <span>‚ûï</span> Dodaj rezerwacjƒô
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal usuwania -->
  <dialog id="deleteModal" class="rounded-xl p-0 backdrop:bg-black/50">
    <div class="p-6 max-w-md">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Usu≈Ñ uczestnika?</h3>
      <p class="text-gray-600 mb-4">
        Czy na pewno chcesz usunƒÖƒá <strong>{participant.lastName} {participant.firstName}</strong>? 
        Ta operacja jest nieodwracalna.
      </p>
      <div class="flex justify-end gap-2">
        <button 
          onclick="document.getElementById('deleteModal').close()"
          class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
        >
          Anuluj
        </button>
        <form method="POST">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            Usu≈Ñ
          </button>
        </form>
      </div>
    </div>
  </dialog>
  <!-- Modal dodawania certyfikatu ADR -->
  <dialog id="addCertModal" class="rounded-xl p-0 backdrop:bg-black/50 w-full max-w-md">
    <div class="p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Dodaj certyfikat ADR</h3>
      <form id="certForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Zakres uprawnie≈Ñ *</label>
          <select 
            name="classes" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)]"
          >
            <option value="podstawowy">Podstawowy</option>
            <option value="podstawowy,cysterny">Podstawowy + Cysterny</option>
            <option value="cysterny">Cysterny (rozszerzenie)</option>
            <option value="klasa1">Klasa 1 (materia≈Çy wybuchowe)</option>
            <option value="klasa7">Klasa 7 (promieniotw√≥rcze)</option>
          </select>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data wydania</label>
            <input 
              type="date" 
              name="issueDate"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)]"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data wa≈ºno≈õci *</label>
            <input 
              type="date" 
              name="expiryDate"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)]"
            />
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Numer za≈õwiadczenia</label>
          <input 
            type="text" 
            name="certificateNumber"
            placeholder="np. PL/123456/2024"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] font-mono"
          />
        </div>
        
        <div>
          <label class="flex items-center gap-2">
            <input 
              type="checkbox" 
              name="isFirst"
              class="w-4 h-4 rounded border-gray-300 text-[var(--accent)]"
            />
            <span class="text-sm">To sƒÖ pierwsze uprawnienia ADR tej osoby</span>
          </label>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Notatki</label>
          <textarea 
            name="notes"
            rows="2"
            placeholder="Opcjonalne uwagi..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)]"
          ></textarea>
        </div>
        
        <div class="flex justify-end gap-2 pt-4 border-t">
          <button 
            type="button"
            onclick="document.getElementById('addCertModal').close()"
            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            Anuluj
          </button>
          <button type="submit" class="px-4 py-2 bg-[var(--accent)] text-white rounded-lg hover:bg-opacity-90">
            Dodaj certyfikat
          </button>
        </div>
      </form>
    </div>
  </dialog>
  
  <script define:vars={{ participantId: participant.id }}>
    document.getElementById('certForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const data = {
        classes: formData.get('classes'),
        issueDate: formData.get('issueDate') || null,
        expiryDate: formData.get('expiryDate'),
        certificateNumber: formData.get('certificateNumber') || null,
        isFirst: formData.get('isFirst') === 'on',
        notes: formData.get('notes') || null,
        createdBy: 'admin',
      };
      
      try {
        const response = await fetch(`/api/participants/${participantId}/certificates`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error('B≈ÇƒÖd dodawania');
        }
        
        // Od≈õwie≈º stronƒô
        window.location.reload();
      } catch (error) {
        alert('B≈ÇƒÖd: ' + error.message);
      }
    });
  </script>
</AdminLayout>
