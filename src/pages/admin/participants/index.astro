---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { participants, reservations, courses } from '../../../db/schema';
import { eq, like, or, desc, count } from 'drizzle-orm';

const search = Astro.url.searchParams.get('search') || '';

// Pobierz uczestnik√≥w
let allParticipants;
if (search) {
  const searchPattern = `%${search}%`;
  allParticipants = await db.select().from(participants)
    .where(
      or(
        like(participants.lastName, searchPattern),
        like(participants.firstName, searchPattern),
        like(participants.phone, searchPattern),
        like(participants.pesel, searchPattern),
        like(participants.email, searchPattern)
      )
    )
    .orderBy(desc(participants.createdAt))
    .limit(100);
} else {
  allParticipants = await db.select().from(participants)
    .orderBy(desc(participants.createdAt))
    .limit(100);
}

// Policz rezerwacje ka≈ºdego uczestnika
const participantsWithCounts = await Promise.all(
  allParticipants.map(async (p) => {
    const resCount = await db
      .select({ count: count() })
      .from(reservations)
      .where(eq(reservations.participantId, p.id));
    return {
      ...p,
      reservationCount: resCount[0].count,
    };
  })
);

function formatDate(dateStr: string | null) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('pl-PL');
}
---

<AdminLayout title="Baza uczestnik√≥w">
  <!-- Search -->
  <form method="GET" class="mb-6">
    <div class="flex gap-2">
      <input 
        type="text" 
        name="search" 
        value={search}
        placeholder="Szukaj: nazwisko, telefon, PESEL, email..."
        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
      />
      <button type="submit" class="btn-primary">
        Szukaj
      </button>
      {search && (
        <a href="/admin/participants" class="btn-secondary">
          Wyczy≈õƒá
        </a>
      )}
    </div>
  </form>
  
  <p class="text-gray-600 mb-4">
    {search ? `Znaleziono: ${allParticipants.length} uczestnik√≥w` : `≈ÅƒÖcznie: ${allParticipants.length} uczestnik√≥w`}
  </p>
  
  <!-- Mobile: Card View -->
  <div class="block md:hidden space-y-3">
    {participantsWithCounts.length === 0 ? (
      <div class="bg-white rounded-xl p-6 text-center text-gray-500">
        {search ? 'Nie znaleziono uczestnik√≥w' : 'Brak uczestnik√≥w w bazie'}
      </div>
    ) : (
      participantsWithCounts.map((p) => (
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0 flex-1">
              <a href={`/admin/participants/${p.id}`} class="font-bold text-[var(--primary)] hover:text-[var(--accent)] block truncate">
                {p.lastName} {p.firstName}
              </a>
              <a href={`tel:${p.phone}`} class="text-[var(--accent)] font-mono text-sm block mt-1">
                üìû {p.phone}
              </a>
              {p.email && <div class="text-xs text-gray-500 truncate mt-1">‚úâÔ∏è {p.email}</div>}
            </div>
            <div class="flex flex-col items-end gap-1 flex-shrink-0">
              {p.hasCurrentAdr ? (
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">ADR ‚úì</span>
              ) : (
                <span class="px-2 py-1 bg-gray-100 text-gray-500 rounded text-xs">brak ADR</span>
              )}
              <span class="px-2 py-1 bg-[var(--accent)]/10 text-[var(--accent)] rounded text-xs font-bold">
                {p.reservationCount} szk.
              </span>
            </div>
          </div>
        </div>
      ))
    )}
  </div>
  
  <!-- Desktop: Table View -->
  <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 border-b">
        <tr>
          <th class="text-left p-4 font-medium text-gray-700">Nazwisko i imiƒô</th>
          <th class="text-left p-4 font-medium text-gray-700">Telefon</th>
          <th class="text-left p-4 font-medium text-gray-700">Email</th>
          <th class="text-left p-4 font-medium text-gray-700">ADR</th>
          <th class="text-left p-4 font-medium text-gray-700">Szkole≈Ñ</th>
          <th class="text-left p-4 font-medium text-gray-700">Akcje</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {participantsWithCounts.length === 0 ? (
          <tr>
            <td colspan="6" class="p-8 text-center text-gray-500">
              {search ? 'Nie znaleziono uczestnik√≥w' : 'Brak uczestnik√≥w w bazie'}
            </td>
          </tr>
        ) : (
          participantsWithCounts.map((p) => (
            <tr class="hover:bg-gray-50">
              <td class="p-4">
                <div class="font-medium">{p.lastName} {p.firstName}</div>
                {p.city && <div class="text-sm text-gray-500">{p.city}</div>}
              </td>
              <td class="p-4">
                <a href={`tel:${p.phone}`} class="font-mono text-sm text-[var(--accent)] hover:underline">{p.phone}</a>
              </td>
              <td class="p-4 text-sm">{p.email || '-'}</td>
              <td class="p-4">
                {p.hasCurrentAdr ? (
                  <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">TAK</span>
                ) : (
                  <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">NIE</span>
                )}
              </td>
              <td class="p-4">
                <span class={p.reservationCount > 0 ? 'font-bold text-[var(--accent)]' : 'text-gray-500'}>
                  {p.reservationCount}
                </span>
              </td>
              <td class="p-4">
                <div class="flex items-center gap-3">
                  <a href={`/admin/participants/${p.id}`} class="text-[var(--accent)] hover:underline text-sm font-medium">
                    Edytuj
                  </a>
                  <a href={`/admin/reservations/new?participantId=${p.id}`} class="text-blue-600 hover:underline text-sm">
                    + Rezerwacja
                  </a>
                </div>
              </td>
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>
</AdminLayout>
