---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { smsTemplates, smsLog, settings } from '../../../db/schema';
import { desc, eq, count } from 'drizzle-orm';
import { initDefaultTemplates } from '../../../lib/sms';

// Inicjalizuj domy≈õlne szablony je≈õli brak
await initDefaultTemplates();

// Pobierz numer admina z ustawie≈Ñ
const adminPhoneSetting = await db.select().from(settings).where(eq(settings.key, 'admin_phone')).get();
const adminPhone = adminPhoneSetting?.value || '';

let message = '';
let messageType = 'success';

// Obs≈Çuga formularza
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'update_template') {
      const id = parseInt(formData.get('id') as string);
      const template = formData.get('template') as string;
      const enabled = formData.get('enabled') === 'on';
      
      await db.update(smsTemplates)
        .set({ 
          template, 
          enabled,
          updatedAt: new Date().toISOString() 
        })
        .where(eq(smsTemplates.id, id));
      
      message = 'Szablon zaktualizowany';
    } else if (action === 'update_admin_phone') {
      const phone = (formData.get('admin_phone') as string || '').replace(/\s/g, '');
      
      // Upsert - wstaw lub zaktualizuj
      const existing = await db.select().from(settings).where(eq(settings.key, 'admin_phone')).get();
      if (existing) {
        await db.update(settings)
          .set({ value: phone, updatedAt: new Date().toISOString() })
          .where(eq(settings.key, 'admin_phone'));
      } else {
        await db.insert(settings).values({
          key: 'admin_phone',
          value: phone,
          updatedAt: new Date().toISOString(),
        });
      }
      
      message = 'Numer telefonu admina zapisany';
    }
  } catch (e) {
    console.error(e);
    message = 'B≈ÇƒÖd podczas zapisywania';
    messageType = 'error';
  }
}

// Pobierz szablony
const templates = await db.select().from(smsTemplates).orderBy(smsTemplates.event);

// Pobierz statystyki SMS
const totalSent = await db.select({ count: count() }).from(smsLog);
const recentLogs = await db.select()
  .from(smsLog)
  .orderBy(desc(smsLog.createdAt))
  .limit(10);

// Dostƒôpne zmienne
const availableVariables = [
  { name: 'imie', desc: 'Imiƒô uczestnika' },
  { name: 'nazwisko', desc: 'Nazwisko uczestnika' },
  { name: 'telefon', desc: 'Telefon uczestnika' },
  { name: 'email', desc: 'Email uczestnika' },
  { name: 'kurs', desc: 'Typ kursu (podstawowy, cysterny...)' },
  { name: 'data', desc: 'Data rozpoczƒôcia kursu' },
  { name: 'data_koniec', desc: 'Data zako≈Ñczenia kursu' },
];
---

<AdminLayout title="Ustawienia SMS">
  <div class="max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-900">üì± Ustawienia SMS</h1>
      <div class="text-sm text-gray-500">
        Wys≈Çano ≈ÇƒÖcznie: <span class="font-bold text-[var(--primary)]">{totalSent[0].count}</span> SMS
      </div>
    </div>

    {message && (
      <div class={`mb-4 p-4 rounded-lg ${messageType === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : 'bg-green-50 border border-green-200 text-green-800'}`}>
        {message}
      </div>
    )}

    <!-- Numer telefonu admina -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <h2 class="font-bold text-lg mb-4">üìû Powiadomienia dla admina</h2>
      <p class="text-sm text-gray-600 mb-4">
        Na ten numer bƒôdƒÖ wysy≈Çane SMS-y o nowych zg≈Çoszeniach ze strony.
      </p>
      <form method="POST" class="flex gap-3 items-end">
        <input type="hidden" name="action" value="update_admin_phone" />
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Numer telefonu admina</label>
          <input 
            type="tel" 
            name="admin_phone" 
            value={adminPhone}
            placeholder="502 611 639"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
        <button type="submit" class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg hover:bg-[var(--primary-light)]">
          Zapisz
        </button>
      </form>
      {!adminPhone && (
        <p class="text-amber-600 text-sm mt-2">‚ö†Ô∏è Brak numeru - SMS-y do admina nie bƒôdƒÖ wysy≈Çane</p>
      )}
    </div>

    <!-- Dostƒôpne zmienne -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
      <h3 class="font-semibold text-blue-800 mb-2">üìù Dostƒôpne zmienne w szablonach:</h3>
      <div class="flex flex-wrap gap-2">
        {availableVariables.map(v => (
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-white rounded text-sm border border-blue-200">
            <code class="text-blue-600 font-mono">{`{{${v.name}}}`}</code>
            <span class="text-gray-500 text-xs">- {v.desc}</span>
          </span>
        ))}
      </div>
    </div>

    <!-- Szablony -->
    <div class="space-y-4 mb-8">
      {templates.map(t => (
        <form method="POST" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <input type="hidden" name="action" value="update_template" />
          <input type="hidden" name="id" value={t.id} />
          
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="font-bold text-gray-900">{t.name}</h3>
              <span class="text-xs text-gray-500 font-mono">{t.event}</span>
            </div>
            <label class="flex items-center gap-2">
              <input 
                type="checkbox" 
                name="enabled" 
                checked={t.enabled}
                class="w-5 h-5 rounded border-gray-300 text-[var(--success)] focus:ring-[var(--success)]"
              />
              <span class="text-sm font-medium">Aktywny</span>
            </label>
          </div>
          
          <textarea 
            name="template"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent font-mono text-sm"
          >{t.template}</textarea>
          
          <div class="flex items-center justify-between mt-3">
            <span class="text-xs text-gray-400">
              {t.updatedAt ? `Ostatnia zmiana: ${new Date(t.updatedAt).toLocaleString('pl-PL')}` : ''}
            </span>
            <button type="submit" class="px-4 py-2 bg-[var(--primary)] text-white rounded-lg hover:bg-[var(--primary-light)] text-sm">
              Zapisz
            </button>
          </div>
        </form>
      ))}
    </div>

    <!-- Historia SMS -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="p-4 border-b">
        <h2 class="font-bold text-lg">üìä Ostatnie wysy≈Çki</h2>
      </div>
      <div class="divide-y">
        {recentLogs.length === 0 ? (
          <div class="p-4 text-gray-500 text-center">Brak wys≈Çanych SMS</div>
        ) : (
          recentLogs.map(log => (
            <div class="p-4">
              <div class="flex items-center justify-between mb-1">
                <span class="font-medium">{log.recipientName}</span>
                <span class={`text-xs px-2 py-1 rounded ${log.status === 'sent' || log.status === 'delivered' ? 'bg-green-100 text-green-800' : log.status === 'failed' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}`}>
                  {log.status}
                </span>
              </div>
              <div class="text-sm text-gray-500 mb-1">{log.recipientPhone}</div>
              <div class="text-sm text-gray-700 bg-gray-50 rounded p-2 font-mono">
                {log.message.length > 100 ? log.message.substring(0, 100) + '...' : log.message}
              </div>
              <div class="text-xs text-gray-400 mt-2">
                {new Date(log.createdAt || '').toLocaleString('pl-PL')}
                {log.cost && <span class="ml-2">‚Ä¢ {log.cost} pkt</span>}
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  </div>
</AdminLayout>
