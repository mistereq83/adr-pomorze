---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { courses } from '../../../db/schema';

let error = '';
let success = false;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    
    await db.insert(courses).values({
      courseType: formData.get('courseType') as string,
      startDate: formData.get('startDate') as string,
      endDate: formData.get('endDate') as string,
      location: formData.get('location') as string || 'Gdańsk',
      maxParticipants: parseInt(formData.get('maxParticipants') as string) || 15,
      price: formData.get('price') ? parseFloat(formData.get('price') as string) : null,
      status: 'open',
      notes: formData.get('notes') as string || null,
      createdAt: new Date().toISOString(),
    });
    
    return Astro.redirect('/admin/courses');
  } catch (e) {
    console.error(e);
    error = 'Błąd podczas dodawania kursu';
  }
}

const courseTypes = [
  { value: 'podstawowy', label: 'Kurs podstawowy' },
  { value: 'cysterny', label: 'Kurs specjalistyczny - cysterny' },
  { value: 'klasa1', label: 'Klasa 1 (materiały wybuchowe)' },
  { value: 'klasa7', label: 'Klasa 7 (promieniotwórcze)' },
  { value: 'odnowienie', label: 'Szkolenie odnawiające' },
];
---

<AdminLayout title="Dodaj nowy kurs">
  <div class="max-w-2xl">
    {error && (
      <div class="bg-red-50 text-red-700 p-4 rounded-lg mb-4">
        {error}
      </div>
    )}
    
    <form method="POST" class="bg-white rounded-xl shadow-sm p-6 space-y-6">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Typ kursu *
          </label>
          <select 
            name="courseType" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          >
            {courseTypes.map(type => (
              <option value={type.value}>{type.label}</option>
            ))}
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Lokalizacja
          </label>
          <input 
            type="text" 
            name="location" 
            value="Gdańsk"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Data rozpoczęcia *
          </label>
          <input 
            type="date" 
            name="startDate" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Data zakończenia *
          </label>
          <input 
            type="date" 
            name="endDate" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Maksymalna liczba uczestników
          </label>
          <input 
            type="number" 
            name="maxParticipants" 
            value="15"
            min="1"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Cena (zł)
          </label>
          <input 
            type="number" 
            name="price" 
            step="0.01"
            placeholder="np. 1200.00"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
          />
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Notatki
        </label>
        <textarea 
          name="notes" 
          rows="3"
          placeholder="Dodatkowe informacje o kursie..."
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
        ></textarea>
      </div>
      
      <div class="flex items-center gap-4">
        <button type="submit" class="btn-primary">
          Dodaj kurs
        </button>
        <a href="/admin/courses" class="text-gray-500 hover:text-gray-700">
          Anuluj
        </a>
      </div>
    </form>
  </div>
</AdminLayout>
