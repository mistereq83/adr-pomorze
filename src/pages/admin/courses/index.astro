---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { courses, reservations } from '../../../db/schema';
import { eq, count, desc, and, notInArray } from 'drizzle-orm';

const allCourses = await db.select().from(courses).orderBy(desc(courses.startDate));

const coursesWithCounts = await Promise.all(
  allCourses.map(async (course) => {
    const reservationCount = await db
      .select({ count: count() })
      .from(reservations)
      .where(
        and(
          eq(reservations.courseId, course.id),
          notInArray(reservations.status, ['cancelled', 'no_show'])
        )
      );
    return {
      ...course,
      reservationCount: reservationCount[0].count,
    };
  })
);

function getStatusBadge(status: string | null) {
  const badges: Record<string, { class: string; label: string; emoji: string }> = {
    open: { class: 'bg-green-100 text-green-800', label: 'Otwarty', emoji: '‚úì' },
    full: { class: 'bg-yellow-100 text-yellow-800', label: 'Pe≈Çny', emoji: 'üîí' },
    completed: { class: 'bg-gray-100 text-gray-800', label: 'Zako≈Ñczony', emoji: '‚úî' },
    cancelled: { class: 'bg-red-100 text-red-800', label: 'Anulowany', emoji: '‚úï' },
  };
  return badges[status || 'open'] || badges.open;
}

function getCourseTypeStyle(type: string) {
  const styles: Record<string, { bg: string; emoji: string; label: string }> = {
    'podstawowy': { bg: 'bg-blue-100 text-blue-800', emoji: 'üìö', label: 'Podstawowy' },
    'cysterny': { bg: 'bg-orange-100 text-orange-800', emoji: 'üõ¢Ô∏è', label: 'Cysterny' },
    'klasa1': { bg: 'bg-purple-100 text-purple-800', emoji: 'üí•', label: 'Klasa 1' },
    'klasa7': { bg: 'bg-yellow-100 text-yellow-800', emoji: '‚ò¢Ô∏è', label: 'Klasa 7' },
    'odnowienie': { bg: 'bg-green-100 text-green-800', emoji: 'üîÑ', label: 'Odnowienie' },
  };
  return styles[type] || { bg: 'bg-gray-100 text-gray-800', emoji: 'üìã', label: type };
}

function formatDateRange(start: string, end: string) {
  const s = new Date(start);
  const e = new Date(end);
  return `${s.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' })} - ${e.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
}
---

<AdminLayout title="ZarzƒÖdzanie kursami">
  <div class="flex items-center justify-between mb-6">
    <p class="text-gray-600">≈ÅƒÖcznie: {allCourses.length} kurs√≥w</p>
    <a href="/admin/courses/new" class="btn-primary">
      + Dodaj kurs
    </a>
  </div>
  
  <!-- Mobile: Card View -->
  <div class="block md:hidden space-y-3">
    {coursesWithCounts.length === 0 ? (
      <div class="bg-white rounded-xl p-6 text-center text-gray-500">
        Brak kurs√≥w. <a href="/admin/courses/new" class="text-[var(--accent)] hover:underline">Dodaj pierwszy</a>
      </div>
    ) : (
      coursesWithCounts.map((course) => {
        const typeStyle = getCourseTypeStyle(course.courseType || '');
        const statusBadge = getStatusBadge(course.status);
        const isFull = course.reservationCount >= (course.maxParticipants || 15);
        
        return (
          <div 
            onclick={`window.location.href='/admin/courses/view/${course.id}'`}
            class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer"
          >
            <div class="flex items-start justify-between gap-3 mb-3">
              <div class="flex items-center gap-2">
                <span class="text-2xl">{typeStyle.emoji}</span>
                <div>
                  <div class="font-bold text-[var(--primary)]">{typeStyle.label}</div>
                  <div class="text-sm text-gray-500">{formatDateRange(course.startDate, course.endDate)}</div>
                </div>
              </div>
              <span class={`px-2 py-1 rounded text-xs font-medium ${statusBadge.class}`}>
                {statusBadge.emoji} {statusBadge.label}
              </span>
            </div>
            
            <div class="flex items-center justify-between text-sm mb-3">
              <span class={isFull ? 'text-red-600 font-bold' : 'text-gray-600'}>
                üë• {course.reservationCount} / {course.maxParticipants}
              </span>
            </div>
            
            <div class="flex gap-2 pt-3 border-t" onclick="event.stopPropagation()">
              <a 
                href={`/admin/courses/${course.id}`}
                class="flex-1 text-center py-2 px-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors"
              >
                ‚úèÔ∏è Edytuj
              </a>
              <a 
                href={`/admin/reservations/new?courseId=${course.id}`}
                class="flex-1 text-center py-2 px-3 bg-[var(--accent)]/10 text-[var(--accent)] rounded-lg text-sm font-medium hover:bg-[var(--accent)]/20 transition-colors"
              >
                ‚ûï Uczestnik
              </a>
            </div>
          </div>
        );
      })
    )}
  </div>
  
  <!-- Desktop: Table View -->
  <div class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden">
    <table class="w-full">
      <thead class="bg-gray-50 border-b">
        <tr>
          <th class="text-left p-4 font-medium text-gray-700">Data</th>
          <th class="text-left p-4 font-medium text-gray-700">Typ kursu</th>
          <th class="text-left p-4 font-medium text-gray-700">Zapisanych</th>
          <th class="text-left p-4 font-medium text-gray-700">Status</th>
          <th class="text-left p-4 font-medium text-gray-700">Akcje</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {coursesWithCounts.length === 0 ? (
          <tr>
            <td colspan="7" class="p-8 text-center text-gray-500">
              Brak kurs√≥w. <a href="/admin/courses/new" class="text-[var(--accent)] hover:underline">Dodaj pierwszy kurs</a>
            </td>
          </tr>
        ) : (
          coursesWithCounts.map((course) => {
            const typeStyle = getCourseTypeStyle(course.courseType || '');
            const statusBadge = getStatusBadge(course.status);
            
            return (
              <tr 
                class="hover:bg-gray-50 cursor-pointer transition-colors"
                onclick={`window.location.href='/admin/courses/view/${course.id}'`}
              >
                <td class="p-4">
                  <div class="font-medium">{formatDateRange(course.startDate, course.endDate)}</div>
                </td>
                <td class="p-4">
                  <span class={`px-2 py-1 rounded text-sm font-medium ${typeStyle.bg}`}>
                    {typeStyle.emoji} {typeStyle.label}
                  </span>
                </td>
                <td class="p-4">
                  <span class={course.reservationCount >= (course.maxParticipants || 15) ? 'text-red-600 font-bold' : ''}>
                    {course.reservationCount} / {course.maxParticipants}
                  </span>
                </td>
                <td class="p-4">
                  <span class={`px-2 py-1 rounded text-xs font-medium ${statusBadge.class}`}>
                    {statusBadge.label}
                  </span>
                </td>
                <td class="p-4" onclick="event.stopPropagation()">
                  <div class="flex items-center gap-3">
                    <a href={`/admin/courses/${course.id}`} class="text-[var(--accent)] hover:underline text-sm font-medium">
                      ‚úèÔ∏è Edytuj
                    </a>
                    <a href={`/admin/reservations/new?courseId=${course.id}`} class="text-blue-600 hover:underline text-sm">
                      + Uczestnik
                    </a>
                  </div>
                </td>
              </tr>
            );
          })
        )}
      </tbody>
    </table>
  </div>
</AdminLayout>
