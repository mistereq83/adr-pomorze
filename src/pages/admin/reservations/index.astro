---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db';
import { reservations, participants, courses } from '../../../db/schema';
import { eq, desc } from 'drizzle-orm';

const courseIdParam = Astro.url.searchParams.get('courseId');
const statusParam = Astro.url.searchParams.get('status');

// Pobierz rezerwacje z joinami
let allReservations = await db
  .select({
    reservation: reservations,
    participant: participants,
    course: courses,
  })
  .from(reservations)
  .leftJoin(participants, eq(reservations.participantId, participants.id))
  .leftJoin(courses, eq(reservations.courseId, courses.id))
  .orderBy(desc(reservations.createdAt));

// Filtruj
if (courseIdParam) {
  allReservations = allReservations.filter(r => r.reservation.courseId === parseInt(courseIdParam));
}
if (statusParam) {
  allReservations = allReservations.filter(r => r.reservation.status === statusParam);
}

function getStatusBadge(status: string | null) {
  const badges: Record<string, { class: string; label: string }> = {
    pending: { class: 'bg-yellow-100 text-yellow-800', label: 'Oczekuje' },
    confirmed: { class: 'bg-blue-100 text-blue-800', label: 'Potwierdzona' },
    paid: { class: 'bg-green-100 text-green-800', label: 'OpÅ‚acona' },
    completed: { class: 'bg-gray-100 text-gray-800', label: 'ZakoÅ„czona' },
    cancelled: { class: 'bg-red-100 text-red-800', label: 'Anulowana' },
    no_show: { class: 'bg-red-100 text-red-800', label: 'NieobecnoÅ›Ä‡' },
  };
  return badges[status || 'pending'] || badges.pending;
}

// Status jednopoziomowy - bez osobnej pÅ‚atnoÅ›ci

function formatDate(dateStr: string | null) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('pl-PL');
}
---

<AdminLayout title="ZarzÄ…dzanie rezerwacjami">
  <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
    <div class="flex flex-wrap gap-2">
      <a 
        href="/admin/reservations" 
        class={`px-3 py-1 rounded text-sm ${!statusParam ? 'bg-[var(--primary)] text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
      >
        Wszystkie
      </a>
      <a 
        href="/admin/reservations?status=pending" 
        class={`px-3 py-1 rounded text-sm ${statusParam === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
      >
        OczekujÄ…ce
      </a>
      <a 
        href="/admin/reservations?status=confirmed" 
        class={`px-3 py-1 rounded text-sm ${statusParam === 'confirmed' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
      >
        Potwierdzone
      </a>
      <a 
        href="/admin/reservations?status=paid" 
        class={`px-3 py-1 rounded text-sm ${statusParam === 'paid' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
      >
        OpÅ‚acone
      </a>
    </div>
    <a href="/admin/reservations/new" class="btn-primary">
      + Dodaj rezerwacjÄ™
    </a>
  </div>
  
  {allReservations.length === 0 ? (
    <div class="bg-white rounded-xl shadow-sm p-8 text-center text-gray-500">
      Brak rezerwacji
    </div>
  ) : (
    <div class="space-y-3">
      {allReservations.map((r) => (
        <a 
          href={`/admin/reservations/${r.reservation.id}`}
          class="block bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow"
        >
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-gray-900 truncate">
                {r.participant?.firstName} {r.participant?.lastName}
              </div>
              <div class="text-sm text-gray-500 mt-0.5">
                <a href={`tel:${r.participant?.phone}`} class="hover:text-[var(--accent)]" onclick="event.stopPropagation()">
                  {r.participant?.phone}
                </a>
              </div>
            </div>
            <select 
              class={`px-2 py-1 rounded text-xs font-medium border-0 cursor-pointer ${getStatusBadge(r.reservation.status).class}`}
              data-reservation-id={r.reservation.id}
              data-field="status"
              onchange="updateReservation(this)"
              onclick="event.preventDefault(); event.stopPropagation();"
            >
              <option value="pending" selected={r.reservation.status === 'pending'}>Oczekuje</option>
              <option value="confirmed" selected={r.reservation.status === 'confirmed'}>Potwierdzona</option>
              <option value="paid" selected={r.reservation.status === 'paid'}>OpÅ‚acona</option>
              <option value="completed" selected={r.reservation.status === 'completed'}>ZakoÅ„czona</option>
              <option value="cancelled" selected={r.reservation.status === 'cancelled'}>Anulowana</option>
              <option value="no_show" selected={r.reservation.status === 'no_show'}>NieobecnoÅ›Ä‡</option>
            </select>
          </div>
          
          {r.course && (
            <div class="mt-3 pt-3 border-t border-gray-100 flex items-center gap-4 text-sm">
              <div class="flex items-center gap-1.5">
                <span class="text-gray-400">ðŸ“…</span>
                <span class="font-medium">{formatDate(r.course.startDate)}</span>
              </div>
              <div class="text-gray-500 capitalize">{r.course.courseType}</div>
            </div>
          )}
        </a>
      ))}
    </div>
  )}
</AdminLayout>

<script is:inline>
async function updateReservation(select) {
  const id = select.dataset.reservationId;
  const field = select.dataset.field;
  const value = select.value;
  
  try {
    const res = await fetch(`/api/reservations/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ [field]: value }),
    });
    
    if (res.ok) {
      // Refresh badge colors
      location.reload();
    } else {
      alert('BÅ‚Ä…d aktualizacji');
    }
  } catch (e) {
    alert('BÅ‚Ä…d poÅ‚Ä…czenia');
  }
}
</script>
