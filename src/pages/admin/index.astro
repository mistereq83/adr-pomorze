---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { db } from '../../db';
import { courses, reservations, participants } from '../../db/schema';
import { eq, count, desc, gte } from 'drizzle-orm';

// Statystyki
const totalCourses = await db.select({ count: count() }).from(courses);
const openCourses = await db.select({ count: count() }).from(courses).where(eq(courses.status, 'open'));
const totalReservations = await db.select({ count: count() }).from(reservations);
const pendingReservations = await db.select({ count: count() }).from(reservations).where(eq(reservations.status, 'pending'));
const totalParticipants = await db.select({ count: count() }).from(participants);

// Ostatnie rezerwacje
const recentReservations = await db
  .select({
    reservation: reservations,
    participant: participants,
    course: courses,
  })
  .from(reservations)
  .leftJoin(participants, eq(reservations.participantId, participants.id))
  .leftJoin(courses, eq(reservations.courseId, courses.id))
  .orderBy(desc(reservations.createdAt))
  .limit(5);

// Najbli≈ºsze kursy z liczbƒÖ zapisanych
const upcomingCoursesRaw = await db
  .select()
  .from(courses)
  .where(eq(courses.status, 'open'))
  .orderBy(courses.startDate)
  .limit(5);

// Pobierz liczbƒô zapisanych na ka≈ºdy kurs
const upcomingCourses = await Promise.all(
  upcomingCoursesRaw.map(async (c) => {
    const enrolled = await db
      .select({ count: count() })
      .from(reservations)
      .where(eq(reservations.courseId, c.id));
    return { ...c, enrolledCount: enrolled[0].count };
  })
);

const stats = {
  courses: totalCourses[0].count,
  openCourses: openCourses[0].count,
  reservations: totalReservations[0].count,
  pendingReservations: pendingReservations[0].count,
  participants: totalParticipants[0].count,
};

function formatDate(dateStr: string | null) {
  if (!dateStr) return '-';
  return new Date(dateStr).toLocaleDateString('pl-PL');
}

function getStatusBadge(status: string | null) {
  const badges: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    confirmed: 'bg-blue-100 text-blue-800',
    paid: 'bg-green-100 text-green-800',
    completed: 'bg-gray-100 text-gray-800',
    cancelled: 'bg-red-100 text-red-800',
  };
  return badges[status || 'pending'] || 'bg-gray-100 text-gray-800';
}

function getStatusLabel(status: string | null) {
  const labels: Record<string, string> = {
    pending: 'Oczekuje',
    confirmed: 'Potwierdzona',
    paid: 'Op≈Çacona',
    completed: 'Zako≈Ñczona',
    cancelled: 'Anulowana',
    no_show: 'Nieobecno≈õƒá',
  };
  return labels[status || 'pending'] || status || 'Nieznany';
}

function getSourceLabel(source: string | null) {
  const labels: Record<string, string> = {
    website: 'Strona WWW',
    manual: 'Rƒôcznie',
    telefon: 'Telefon',
    email: 'Email',
  };
  return labels[source || 'website'] || source || '';
}

// Status jednopoziomowy - bez osobnej p≈Çatno≈õci
---

<AdminLayout title="Dashboard">
  <!-- Main Stats - otwarte kursy i oczekujƒÖce -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <a href="/admin/courses" class="bg-gradient-to-br from-[var(--success)] to-emerald-600 rounded-xl p-6 shadow-lg text-white hover:shadow-xl transition-shadow">
      <div class="text-5xl font-black">{stats.openCourses}</div>
      <div class="text-white/80 font-medium">Otwartych kurs√≥w</div>
    </a>
    <a href="/admin/reservations?status=pending" class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl p-6 shadow-lg text-white hover:shadow-xl transition-shadow">
      <div class="text-5xl font-black">{stats.pendingReservations}</div>
      <div class="text-white/80 font-medium">OczekujƒÖcych rezerwacji</div>
    </a>
  </div>
  
  <!-- Secondary Stats -->
  <div class="grid grid-cols-3 gap-3 mb-6">
    <div class="bg-white rounded-xl p-3 shadow-sm text-center">
      <div class="text-xl font-bold text-gray-700">{stats.courses}</div>
      <div class="text-gray-500 text-xs">Wszystkich kurs√≥w</div>
    </div>
    <div class="bg-white rounded-xl p-3 shadow-sm text-center">
      <div class="text-xl font-bold text-gray-700">{stats.reservations}</div>
      <div class="text-gray-500 text-xs">Rezerwacji</div>
    </div>
    <div class="bg-white rounded-xl p-3 shadow-sm text-center">
      <div class="text-xl font-bold text-gray-700">{stats.participants}</div>
      <div class="text-gray-500 text-xs">Uczestnik√≥w</div>
    </div>
  </div>
  
  <!-- Quick actions - na g√≥rze -->
  <div class="flex flex-wrap items-center gap-3 mb-8">
    <a href="/admin/courses/new" class="btn-primary">
      + Dodaj kurs
    </a>
    <a href="/admin/reservations/new" class="btn-primary bg-[var(--success)] hover:bg-emerald-600">
      + Dodaj rezerwacjƒô
    </a>
    
    <!-- Live search uczestnik√≥w -->
    <div class="relative flex-1 min-w-[250px] max-w-md">
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
        <input 
          type="text" 
          id="participant-search" 
          placeholder="Szukaj uczestnika..."
          autocomplete="off"
          readonly
          class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"
        />
      </div>
      <!-- Wyniki wyszukiwania -->
      <div id="search-results" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden max-h-80 overflow-y-auto">
        <!-- Wype≈Çniane przez JS -->
      </div>
    </div>
  </div>
  
  <div class="grid lg:grid-cols-2 gap-6">
    <!-- Ostatnie rezerwacje -->
    <div class="bg-white rounded-xl shadow-sm">
      <div class="p-4 border-b flex items-center justify-between">
        <h2 class="font-bold text-lg">Ostatnie zg≈Çoszenia</h2>
        <a href="/admin/reservations" class="text-[var(--accent)] text-sm hover:underline">Zobacz wszystkie ‚Üí</a>
      </div>
      <div class="divide-y">
        {recentReservations.length === 0 ? (
          <div class="p-4 text-gray-500 text-center">Brak rezerwacji</div>
        ) : (
          recentReservations.map((r) => (
            <div class="p-4 hover:bg-gray-50">
              <div class="flex items-center justify-between mb-1">
                <span class="font-medium">
                  {r.participant?.firstName} {r.participant?.lastName}
                </span>
                <span class={`text-xs px-2 py-1 rounded ${getStatusBadge(r.reservation.status)}`}>
                  {getStatusLabel(r.reservation.status)}
                </span>
              </div>
              <div class="text-sm text-gray-500">
                {r.course?.courseType} ‚Ä¢ {formatDate(r.course?.startDate || null)}
              </div>
              <div class="text-xs text-gray-400 mt-1">
                {getSourceLabel(r.reservation.source)}
              </div>
            </div>
          ))
        )}
      </div>
    </div>
    
    <!-- Najbli≈ºsze kursy -->
    <div class="bg-white rounded-xl shadow-sm">
      <div class="p-4 border-b flex items-center justify-between">
        <h2 class="font-bold text-lg">Najbli≈ºsze kursy</h2>
        <a href="/admin/courses" class="text-[var(--accent)] text-sm hover:underline">ZarzƒÖdzaj ‚Üí</a>
      </div>
      <div class="divide-y">
        {upcomingCourses.length === 0 ? (
          <div class="p-4 text-gray-500 text-center">Brak otwartych kurs√≥w</div>
        ) : (
          upcomingCourses.map((c) => (
            <a href={`/admin/courses/${c.id}`} class="block p-4 hover:bg-gray-50">
              <div class="flex items-center justify-between mb-1">
                <span class="font-mono font-medium">{c.startDate} - {c.endDate}</span>
                <span class={`text-xs px-2 py-1 rounded ${c.courseType === 'cysterny' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}`}>
                  {c.courseType}
                </span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500">{c.location}</span>
                <span class="font-bold text-[var(--primary)]">
                  üë• {c.enrolledCount} os√≥b
                </span>
              </div>
            </a>
          ))
        )}
      </div>
    </div>
  </div>
  

  <script>
    const searchInput = document.getElementById('participant-search');
    const searchResults = document.getElementById('search-results');
    let debounceTimer;
    
    // Usu≈Ñ readonly po klikniƒôciu (zapobiega auto-focus i klawiaturze na mobile przy ≈Çadowaniu)
    if (searchInput) {
      searchInput.addEventListener('click', function() {
        this.removeAttribute('readonly');
        this.focus();
      }, { once: false });
      
      searchInput.addEventListener('touchstart', function() {
        this.removeAttribute('readonly');
      }, { once: false });
    }
    
    searchInput?.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      clearTimeout(debounceTimer);
      
      if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
      }
      
      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(`/api/participants?search=${encodeURIComponent(query)}`);
          const participants = await response.json();
          
          if (participants.length === 0) {
            searchResults.innerHTML = `
              <div class="p-4 text-gray-500 text-center">
                Nie znaleziono uczestnik√≥w
                <a href="/admin/participants" class="block mt-2 text-[var(--accent)] hover:underline text-sm">
                  Pe≈Çna lista ‚Üí
                </a>
              </div>
            `;
          } else {
            searchResults.innerHTML = participants.slice(0, 10).map(p => `
              <a href="/admin/participants/${p.id}" class="block p-3 hover:bg-gray-50 border-b last:border-b-0">
                <div class="font-medium">${p.firstName} ${p.lastName}</div>
                <div class="text-sm text-gray-500">${p.phone || ''} ${p.email ? '‚Ä¢ ' + p.email : ''}</div>
              </a>
            `).join('');
            
            if (participants.length > 10) {
              searchResults.innerHTML += `
                <a href="/admin/participants?search=${encodeURIComponent(query)}" class="block p-3 text-center text-[var(--accent)] hover:bg-gray-50 text-sm">
                  Zobacz wszystkie (${participants.length}) ‚Üí
                </a>
              `;
            }
          }
          
          searchResults.classList.remove('hidden');
        } catch (error) {
          console.error('Search error:', error);
        }
      }, 300);
    });
    
    // Ukryj wyniki po klikniƒôciu poza
    document.addEventListener('click', (e) => {
      if (!searchInput?.contains(e.target) && !searchResults?.contains(e.target)) {
        searchResults?.classList.add('hidden');
      }
    });
    
    // Poka≈º wyniki po focus je≈õli jest tekst
    searchInput?.addEventListener('focus', () => {
      if (searchInput.value.trim().length >= 2 && searchResults?.innerHTML) {
        searchResults.classList.remove('hidden');
      }
    });
  </script>
</AdminLayout>
